<!DOCTYPE html> <html class=no-js lang style><!--
 Page saved with SingleFile 
 url: https://aswinmohan.me/pagewise-js-liveview 
 saved date: Sat Jul 30 2022 02:30:23 GMT+0200 (Central European Summer Time)
--><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="ie=edge">
<title>Page Specific Javascript with Phoenix LiveView and Esbuild</title>
<meta name=description content="Learn how to split your LiveView Javascript pagewise with esbuild, so your main app.js file stays small and people only download and execute the javascript they require.">
<meta name=viewport content="width=device-width, initial-scale=1">
<style media=screen>/*! tailwindcss v3.0.24 | MIT License | https://tailwindcss.com*/*,:after,:before{box-sizing:border-box;border:0 solid #e5e7eb}:after,:before{--tw-content:""}html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;-o-tab-size:4;tab-size:4;font-family:Avenir,Helvetica Neue,Helvetica,Arial,system-ui,sans-serif}body{margin:0}h1,h2,h3{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}code{font-size:1em}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}h1,h2,h3,p,pre{margin:0}:disabled{cursor:default}body{margin-left:auto;margin-right:auto;max-width:42rem;--tw-bg-opacity:1;background-color:rgb(250 250 249/var(--tw-bg-opacity));padding:3rem 1.5rem 6rem;text-align:justify;font-size:1rem;line-height:1.5rem;--tw-text-opacity:1;color:rgb(31 41 55/var(--tw-text-opacity));-webkit-font-smoothing:auto;-moz-osx-font-smoothing:auto}article{color:var(--tw-prose-body)}article :where([class~=lead]):not(:where([class~=not-prose] *)){color:var(--tw-prose-lead);font-size:1.25em;line-height:1.6;margin-top:1.2em;margin-bottom:1.2em}article :where(a):not(:where([class~=not-prose] *)){color:var(--tw-prose-links);text-decoration:underline;font-weight:500}article :where(strong):not(:where([class~=not-prose] *)){color:var(--tw-prose-bold);font-weight:600}article :where(ol):not(:where([class~=not-prose] *)){list-style-type:decimal;padding-left:1.625em}article :where(ol[type=A]):not(:where([class~=not-prose] *)){list-style-type:upper-alpha}article :where(ol[type=a]):not(:where([class~=not-prose] *)){list-style-type:lower-alpha}article :where(ol[type=A s]):not(:where([class~=not-prose] *)){list-style-type:upper-alpha}article :where(ol[type=a s]):not(:where([class~=not-prose] *)){list-style-type:lower-alpha}article :where(ol[type=I]):not(:where([class~=not-prose] *)){list-style-type:upper-roman}article :where(ol[type=i]):not(:where([class~=not-prose] *)){list-style-type:lower-roman}article :where(ol[type=I s]):not(:where([class~=not-prose] *)){list-style-type:upper-roman}article :where(ol[type=i s]):not(:where([class~=not-prose] *)){list-style-type:lower-roman}article :where(ol[type="1"]):not(:where([class~=not-prose] *)){list-style-type:decimal}article :where(ul):not(:where([class~=not-prose] *)){list-style-type:disc;padding-left:1.625em}article :where(ol>li):not(:where([class~=not-prose] *))::marker{font-weight:400;color:var(--tw-prose-counters)}article :where(ul>li):not(:where([class~=not-prose] *))::marker{color:var(--tw-prose-bullets)}article :where(hr):not(:where([class~=not-prose] *)){border-color:var(--tw-prose-hr);border-top-width:1px;margin-top:3em;margin-bottom:3em}article :where(blockquote):not(:where([class~=not-prose] *)){font-weight:500;font-style:italic;color:var(--tw-prose-quotes);border-left-width:.25rem;border-left-color:var(--tw-prose-quote-borders);quotes:"“""”""‘""’";margin-top:1.6em;margin-bottom:1.6em;padding-left:1em}article :where(blockquote p:first-of-type):not(:where([class~=not-prose] *)):before{content:open-quote}article :where(blockquote p:last-of-type):not(:where([class~=not-prose] *)):after{content:close-quote}article :where(h1):not(:where([class~=not-prose] *)){color:var(--tw-prose-headings);font-weight:800;font-size:2.25em;margin-top:0;margin-bottom:.8888889em;line-height:1.1111111}article :where(h1 strong):not(:where([class~=not-prose] *)){font-weight:900}article :where(h2):not(:where([class~=not-prose] *)){color:var(--tw-prose-headings);font-weight:700;font-size:1.5em;margin-top:2em;margin-bottom:1em;line-height:1.3333333}article :where(h2 strong):not(:where([class~=not-prose] *)){font-weight:800}article :where(h3):not(:where([class~=not-prose] *)){color:var(--tw-prose-headings);font-weight:600;font-size:1.25em;margin-top:1.6em;margin-bottom:.6em;line-height:1.6}article :where(h3 strong):not(:where([class~=not-prose] *)){font-weight:700}article :where(h4):not(:where([class~=not-prose] *)){color:var(--tw-prose-headings);font-weight:600;margin-top:1.5em;margin-bottom:.5em;line-height:1.5}article :where(h4 strong):not(:where([class~=not-prose] *)){font-weight:700}article :where(figure>*):not(:where([class~=not-prose] *)){margin-top:0;margin-bottom:0}article :where(figcaption):not(:where([class~=not-prose] *)){color:var(--tw-prose-captions);font-size:.875em;line-height:1.4285714;margin-top:.8571429em}article :where(code):not(:where([class~=not-prose] *)){color:var(--tw-prose-code);font-weight:600;font-size:.875em}article :where(code):not(:where([class~=not-prose] *)):before{content:"`"}article :where(code):not(:where([class~=not-prose] *)):after{content:"`"}article :where(a code):not(:where([class~=not-prose] *)){color:var(--tw-prose-links)}article :where(pre):not(:where([class~=not-prose] *)){color:var(--tw-prose-pre-code);background-color:var(--tw-prose-pre-bg);overflow-x:auto;font-weight:400;font-size:.875em;line-height:1.7142857;margin-top:1.7142857em;margin-bottom:1.7142857em;border-radius:.375rem;padding:.8571429em 1.1428571em}article :where(pre code):not(:where([class~=not-prose] *)){background-color:initial;border-width:0;border-radius:0;padding:0;font-weight:inherit;color:inherit;font-size:inherit;font-family:inherit;line-height:inherit}article :where(pre code):not(:where([class~=not-prose] *)):before{content:none}article :where(pre code):not(:where([class~=not-prose] *)):after{content:none}article :where(table):not(:where([class~=not-prose] *)){width:100%;table-layout:auto;text-align:left;margin-top:2em;margin-bottom:2em;font-size:.875em;line-height:1.7142857}article :where(thead):not(:where([class~=not-prose] *)){border-bottom-width:1px;border-bottom-color:var(--tw-prose-th-borders)}article :where(thead th):not(:where([class~=not-prose] *)){color:var(--tw-prose-headings);font-weight:600;vertical-align:bottom;padding-right:.5714286em;padding-bottom:.5714286em;padding-left:.5714286em}article :where(tbody tr):not(:where([class~=not-prose] *)){border-bottom-width:1px;border-bottom-color:var(--tw-prose-td-borders)}article :where(tbody tr:last-child):not(:where([class~=not-prose] *)){border-bottom-width:0}article :where(tbody td):not(:where([class~=not-prose] *)){vertical-align:initial;padding:.5714286em}article{--tw-prose-body:#374151;--tw-prose-headings:#111827;--tw-prose-lead:#4b5563;--tw-prose-links:#111827;--tw-prose-bold:#111827;--tw-prose-counters:#6b7280;--tw-prose-bullets:#d1d5db;--tw-prose-hr:#e5e7eb;--tw-prose-quotes:#111827;--tw-prose-quote-borders:#e5e7eb;--tw-prose-captions:#6b7280;--tw-prose-code:#111827;--tw-prose-pre-code:#e5e7eb;--tw-prose-pre-bg:#1f2937;--tw-prose-th-borders:#d1d5db;--tw-prose-td-borders:#e5e7eb;--tw-prose-invert-body:#d1d5db;--tw-prose-invert-headings:#fff;--tw-prose-invert-lead:#9ca3af;--tw-prose-invert-links:#fff;--tw-prose-invert-bold:#fff;--tw-prose-invert-counters:#9ca3af;--tw-prose-invert-bullets:#4b5563;--tw-prose-invert-hr:#374151;--tw-prose-invert-quotes:#f3f4f6;--tw-prose-invert-quote-borders:#374151;--tw-prose-invert-captions:#9ca3af;--tw-prose-invert-code:#fff;--tw-prose-invert-pre-code:#d1d5db;--tw-prose-invert-pre-bg:#00000080;--tw-prose-invert-th-borders:#4b5563;--tw-prose-invert-td-borders:#374151;font-size:1rem;line-height:1.75}article :where(p):not(:where([class~=not-prose] *)){margin-top:1.25em;margin-bottom:1.25em}article :where(img):not(:where([class~=not-prose] *)){margin-top:2em;margin-bottom:2em}article :where(video):not(:where([class~=not-prose] *)){margin-top:2em;margin-bottom:2em}article :where(figure):not(:where([class~=not-prose] *)){margin-top:2em;margin-bottom:2em}article :where(h2 code):not(:where([class~=not-prose] *)){font-size:.875em}article :where(h3 code):not(:where([class~=not-prose] *)){font-size:.9em}article :where(li):not(:where([class~=not-prose] *)){margin-top:.5em;margin-bottom:.5em}article :where(ol>li):not(:where([class~=not-prose] *)){padding-left:.375em}article :where(ul>li):not(:where([class~=not-prose] *)){padding-left:.375em}article>:where(ul>li p):not(:where([class~=not-prose] *)){margin-top:.75em;margin-bottom:.75em}article>:where(ul>li>:first-child):not(:where([class~=not-prose] *)){margin-top:1.25em}article>:where(ul>li>:last-child):not(:where([class~=not-prose] *)){margin-bottom:1.25em}article>:where(ol>li>:first-child):not(:where([class~=not-prose] *)){margin-top:1.25em}article>:where(ol>li>:last-child):not(:where([class~=not-prose] *)){margin-bottom:1.25em}article :where(ul ul,ul ol,ol ul,ol ol):not(:where([class~=not-prose] *)){margin-top:.75em;margin-bottom:.75em}article :where(hr+*):not(:where([class~=not-prose] *)){margin-top:0}article :where(h2+*):not(:where([class~=not-prose] *)){margin-top:0}article :where(h3+*):not(:where([class~=not-prose] *)){margin-top:0}article :where(h4+*):not(:where([class~=not-prose] *)){margin-top:0}article :where(thead th:first-child):not(:where([class~=not-prose] *)){padding-left:0}article :where(thead th:last-child):not(:where([class~=not-prose] *)){padding-right:0}article :where(tbody td:first-child):not(:where([class~=not-prose] *)){padding-left:0}article :where(tbody td:last-child):not(:where([class~=not-prose] *)){padding-right:0}article>:where(:first-child):not(:where([class~=not-prose] *)){margin-top:0}article>:where(:last-child):not(:where([class~=not-prose] *)){margin-bottom:0}article{margin-top:3rem;max-width:none}article :is(:where(h1,h2,h3,h4,th):not(:where([class~=not-prose] *))){font-size:1.125rem;line-height:1.75rem}article :is(:where(h2):not(:where([class~=not-prose] *))){margin-top:3rem}article :is(:where(h3):not(:where([class~=not-prose] *))){margin-top:1.5rem;font-size:1rem;line-height:1.5rem;font-weight:400}article :is(:where(h4):not(:where([class~=not-prose] *))){font-size:1rem;line-height:1.5rem}article :is(:where(a):not(:where([class~=not-prose] *))){font-weight:400;--tw-text-opacity:1;color:rgb(55 65 81/var(--tw-text-opacity));-webkit-text-decoration-line:none;text-decoration-line:none}article :is(:where(pre):not(:where([class~=not-prose] *))){--tw-bg-opacity:1;background-color:rgb(245 245 244/var(--tw-bg-opacity));--tw-text-opacity:1;color:rgb(55 65 81/var(--tw-text-opacity))}a{border-bottom-width:2px;--tw-border-opacity:1;border-color:rgb(156 163 175/var(--tw-border-opacity));transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}a:hover{border-radius:.375rem;--tw-border-opacity:1;border-color:rgb(234 179 8/var(--tw-border-opacity));--tw-bg-opacity:1;background-color:rgb(254 240 138/var(--tw-bg-opacity));padding-left:.25rem;padding-right:.25rem}h1,h2,h3{display:block;--tw-bg-opacity:1;background-color:rgb(229 231 235/var(--tw-bg-opacity));padding-left:.5rem;padding-right:.5rem}h1{--tw-bg-opacity:1;background-color:rgb(253 224 71/var(--tw-bg-opacity))}h3{display:inline-block}code{border-radius:.375rem;padding-left:.5rem;padding-right:.5rem;font-family:Avenir,Helvetica Neue,Helvetica,Arial,system-ui,sans-serif;font-weight:400}code,pre{border-width:1px;--tw-border-opacity:1;border-color:rgb(156 163 175/var(--tw-border-opacity))}pre{margin-bottom:2rem;margin-top:1rem;border-radius:.5rem;padding:1rem 1rem 0;font-family:Courier,monospace;font-size:.875rem;line-height:1.25rem}*,:after,:before{--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:#3b82f680;--tw-ring-offset-shadow:0 0#0000;--tw-ring-shadow:0 0#0000;--tw-shadow:0 0#0000;--tw-shadow-colored:0 0#0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: }.flex{display:flex}.items-center{align-items:center}.justify-between{justify-content:space-between}</style>
<link rel=canonical href=https://aswinmohan.me/pagewise-js-liveview><meta http-equiv=content-security-policy content="default-src 'none'; font-src 'self' data:; img-src 'self' data:; style-src 'unsafe-inline'; media-src 'self' data:; script-src 'unsafe-inline' data:;"><style>img[src="data:,"],source[src="data:,"]{display:none!important}</style></head>
 <body>
 <header class="flex items-center justify-between">
 <p><a href=https://aswinmohan.me/>back to home</a></p>
 <p>2022-04-25</p>
 </header>
 <article>
 <h1>Page Specific Javascript with Phoenix LiveView and Esbuild</h1>
 <p>
 LiveView has a minimal Javascript footprint, but if you're building a
 client heavy app it can change. While building IndiePaper I implemented
 the realtime editor using JS hooks. This caused the
 <code> app.js </code> file to be around 1.4 MB. Since this file is
 loaded on every page, it wasted bandwidth and CPU time even when people
 didn't use the editor. This post outlines the technique I used to split
 the JS code and only load the required parts for each page.
 </p>
 <section>
 <h2>Code Splitting and Dynamic Imports</h2>
 <p>
 Phoenix uses <code>esbuild</code> to bundle assets. Bundling is the
 process of taking code in separate modules and combining it into a
 single file, minifying and converting it to standard Javascript in the
 process. This is why <code>app.js</code> increases in size when we
 import more node modules. We can reduce the size by splitting the
 files based on the pages that require it and dynamically load the
 required parts only when needed.
 </p>
 <h3>Starting point</h3>
 <p>
 Consider that we have a LiveView app with two pages, one being a JS
 heavy text editor using <a href=https://tiptap.dev/>TipTap</a> .
 Initially we are going to have all the code reside in the
 <code> app.js </code> file.
 </p>
 <pre>import { Editor } from "@tiptap/core";
import StarterKit from "@tiptap/starter-kit";

...

let Hooks = {};
Hooks.SimpleTipTapHtmlEditor = {
  mounted() {
    const contentHTMLElementId = this.el.dataset.contentHtmlElementId;
    const editorElementId = this.el.dataset.editorElementId;

    window.tipTapHtmlEditor = new Editor({
      element: editorElement,
      content: contentHTMLElement.value,
    };
};

let liveSocket = new LiveSocket(socketHost, Socket, {
  params: { _csrf_token: csrfToken },
  hooks: Hooks});
        </pre>
 <p>
 This increases the size of the <code> app.js </code> file. Even though
 the code is only required in the editor page, it is downloaded and
 executed on every page.
 </p>
 <h3>Refactor to Modules</h3>
 <p>
 First step is to extract the code for the editor to a new function,
 export it from a new file <code> simple-editor.js </code> and include
 that in <code>app.js</code>.
 </p>
 <pre># simple-editor.js
import { Editor } from "@tiptap/core";
import StarterKit from "@tiptap/starter-kit";

export function setupSimpleTipTapHtmlEditor(
  contentHTMLElementId,
  editorElementId
) {
  const contentHTMLElement = document.getElementById(contentHTMLElementId);
  const editorElement = document.getElementById(editorElementId);

  window.tipTapHtmlEditor = new Editor({
    element: editorElement,
    content: contentHTMLElement.value,
  });
}
        </pre>
 <h3>Setup Dynamic Import</h3>
 <p>
 Import that file in <code> app.js </code> and replace with the hook
 with the dynamic function call, and remove the old imports from the
 top.
 </p>
 <pre># app.js
let Hooks = {};
Hooks.SimpleTipTapHtmlEditor = {
  mounted() {
    const contentHTMLElementId = this.el.dataset.contentHtmlElementId;
    const editorElementId = this.el.dataset.editorElementId;

    import("./simple-editor").then(
      ({ setupSimpleTipTapHtmlEditor }) =&gt; {
        setupSimpleTipTapHtmlEditor(contentHTMLElementId, editorElementId);
      }
    );
  },
};
        </pre>
 <p>
 The <code> import </code> statement has a different promise based form
 here. When the import is encountered, the chunk of code is fetched
 dynamically and then executed.
 </p>
 <h3>Setup Esbuild Chunking</h3>
 <p>
 When we enable Esbuild chunks, rather than bundling everything
 together, Esbuild creates different <code> chunk </code> files.
 Esbuild in Phoenix is configured with editing
 <code> config/config.exs </code>
 </p>
 <pre># config.exs
...

# Configure esbuild (the version is required)
config :esbuild,
  version: "0.14.0",
  default: [
    args: ~w(js/app.js js/simple-editor.js
        --chunk-names=chunks/[name]-[hash] --splitting --format=esm --bundle --target=es2017 --minify
        --outdir=../priv/static/assets --external:/fonts/* --external:/images/*),
    cd: Path.expand("../assets", __DIR__),
    env: %{"NODE_PATH" =&gt; Path.expand("../deps", __DIR__)}
  ]

        </pre>
 <p>
 We have added the file <code> js/simple-editor.js </code> to list of
 files, and added a set of options to enable splitting.
 </p>
 <pre>--chunk-names=chunks/[name]-[hash] --splitting --format=esm --bundle --target=es2017 --minify
        </pre>
 <h3>Import as module</h3>
 <p>
 Finally you have to set the import of <code> app.js </code> in your
 <code> root.html.heex </code> as a module.
 </p>
 <pre>&lt;script type="module" defer phx-track-static type="text/javascript" src={Routes.static_path(@conn, "/assets/app.js")}&gt;&lt;/script&gt;
        </pre>
 </section>
 <section>
 <h2>Extra bits</h2>
 <p>
 When you load JS files dynamically, there are some gotchas that you
 have to look out for.
 </p>
 <h3>Loading Delay</h3>
 <p>
 Dynamically loaded modules will only start fetching after
 <code> app.js </code> file has started executing. This leads to a
 slight delay, so it's better to inline critical parts in the file
 itself.
 </p>
 <p>
 If you prefer, you can show a loading indicator while the file is
 being downloaded. The example setup requires
 <a href=https://alpinejs.dev/>AlpineJS</a>. We declare
 <code> isLoading </code> on the element where the hook is added and
 set it to true. We use that Alpine variable to show a loading
 indicator. We disable the loading indicator when we recieve an event
 through <code> x-on:hook-loaded </code>
 </p>
 <pre># Element where Hook is loaded
&lt;div id="hook_element"
  phx-hook="SimpleHook"
  x-data="{isLoading: true}"
  x-on:hook-loaded="isLoading = false"&gt;
  &lt;p x-show="isLoading"&gt;Loading Indicator&lt;/p&gt;
  ...
&lt;/div&gt;
        </pre>
 <p>
 When mounting the Hook, we have to sent a
 <code> hook-loaded </code> event to Alpine.
 </p>
 <pre># simple-editor.js
function sendEditorLoaded() {
  let event = new CustomEvent("hook-loaded", {});
  context.el.dispatchEvent(event);
}

export function setupSimpleTipTapHtmlEditor(
  contentHTMLElementId,
  editorElementId
) {
  ...

  sendEditorLoaded();
}
        </pre>
 </section>
 <section>
 <h2>Conclusion</h2>
 <p>
 With this setup, whenever you include a new Hook in a LiveView page,
 the corresponding module gets dynamically imported. The modules are
 chunked automatically and loaded on demand. This leads to only the
 pages that require the Javascript downloading and executing it.
 </p>
 </section>
 </article>
 
