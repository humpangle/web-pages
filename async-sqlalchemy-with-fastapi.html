<!DOCTYPE html> <html lang=en style><!--
 Page saved with SingleFile 
 url: https://stribny.name/blog/fastapi-asyncalchemy/ 
 saved date: Sat Jan 07 2023 07:53:55 GMT+0100 (Central European Standard Time)
--><meta charset=utf-8>
<meta name=description content>
<meta name=referrer content=no-referrer-when-downgrade>
<meta property=og:title content="Async SQLAlchemy with FastAPI">
<meta property=og:type content=article>
<meta property=og:url content=https://stribny.name/blog/fastapi-asyncalchemy/>
<meta property=og:image content=https://stribny.name/images/blog/fastapi-asyncalchemy/cover.png>
<link rel=canonical href=https://stribny.name/blog/fastapi-asyncalchemy/>
<style>:root{--main-color:#375d96ff;--tag-hover-color:rgb(241,241,241);--hp-offset:20px;--hp-accent:rgb(31,84,231)}body{font-family:"Source Sans Pro","Droid Sans",Arial,sans-serif;font-size:1.4em;color:rgb(68,68,68);padding-top:20px;padding-bottom:0;margin-bottom:0}ul li{margin-bottom:12px}a,a:visited{background:linear-gradient(to bottom,var(--main-color) 0%,var(--main-color) 100%);background-position:0 100%;background-repeat:repeat-x;background-size:4px 1px;padding-bottom:1px;color:#000;text-decoration:none;transition:background-size .2s}a:hover{background-size:4px 5px}:not(pre)>code{display:inline-block;background:rgb(255,255,232);padding:2px;border-radius:8px!important}.main-nav{padding-left:20px;padding-right:20px;padding-top:10px;padding-bottom:10px;position:fixed;right:20px;top:20px;background:white;box-shadow:0 0 20px rgb(255,255,255);border-radius:14px}.main-nav a,.main-nav a:visited{padding-right:10px;border:0;background:transparent}.main-nav a:hover{background-size:4px 5px}.home-link,.home-link:visited,.home-link:hover{display:block;background:transparent;text-align:center}@media screen and (max-width:950px){.main-nav{position:absolute;top:20px;right:20px;background:white;text-align:center}.main-nav .article-menu-opener:hover .article-menu-wrapper{visibility:hidden;opacity:0}.main-nav .books-menu-opener:hover .books-menu-wrapper{visibility:hidden;opacity:0}.home-link{display:none}}footer{margin-top:50px;display:block;border-top:2px solid rgb(212,212,212);padding-top:30px;padding-bottom:60px}footer nav{display:flex;align-content:space-between}footer nav>div{flex-grow:1}footer a,footer a:visited{border:0;background-size:0 0;padding-bottom:0}footer a:hover{padding-bottom:0;background-size:4px 5px}.footer-link{display:inline-block;margin-bottom:15px}.footer-name{text-align:right}.footer-name a{color:rgb(55,54,54)}.wrapper{display:grid;grid-template-columns:1fr minmax(auto,calc(75ch - 40px)) 1fr;padding-left:20px;padding-right:20px}.wrapper>*{grid-column:2}.wrapper h1{color:black;text-align:center;font-size:3em}h2,h3{color:var(--main-color)}.article-menu-wrapper{visibility:hidden;position:absolute;left:-360px;transition:opacity 0.5s ease-out;opacity:0;background:transparent}.article-menu{display:flex;min-width:500px;background:white;-moz-box-shadow:0 3px 5px 1px rgb(228,228,228);-webkit-box-shadow:0 3px 5px 1px rgb(228,228,228);box-shadow:0 3px 5px 1px rgb(228,228,228);z-index:10000;border-radius:8px;margin-top:20px;padding:20px}.article-menu-opener{display:inline-block;position:relative}.article-menu-opener:hover .article-menu-wrapper{visibility:visible;opacity:1}.article-menu-group{flex-grow:1;padding-left:2px;padding-right:20px}.article-menu-group div{padding:10px 5px 10px 5px}.article-menu-group a,.article-menu-group a:visited{display:inline-block;background:linear-gradient(to right,var(--main-color) 0%,var(--main-color) 100%);background-position:0 100%;background-repeat:repeat-x;background-size:4px 0;padding:0;color:#000;text-decoration:none;transition:background-size .2s}.article-menu-group a:hover{background-size:4px 4px}.books-menu-wrapper{visibility:hidden;position:absolute;left:-100px;transition:opacity 0.5s ease-out;opacity:0;background:transparent}.books-menu{display:flex;min-width:300px;background:white;-moz-box-shadow:0 3px 5px 1px rgb(228,228,228);-webkit-box-shadow:0 3px 5px 1px rgb(228,228,228);box-shadow:0 3px 5px 1px rgb(228,228,228);z-index:10000;border-radius:8px;margin-top:20px;padding:20px}.books-menu-opener{display:inline-block;position:relative}.books-menu-opener:hover .books-menu-wrapper{visibility:visible;opacity:1}.books-menu-group{flex-grow:1;padding-left:2px;padding-right:20px}.books-menu-group div{padding:10px 5px 10px 5px}.books-menu-group a,.books-menu-group a:visited{display:inline-block;background:linear-gradient(to right,var(--main-color) 0%,var(--main-color) 100%);background-position:0 100%;background-repeat:repeat-x;background-size:4px 0;padding:0;color:#000;text-decoration:none;transition:background-size .2s}.books-menu-group a:hover{background-size:4px 4px}.tag-cloud{margin-bottom:50px}.tag-cloud a{display:inline-block;border:1px solid gray;border-radius:5px;background:linear-gradient(to bottom,var(--tag-hover-color) 0%,var(--tag-hover-color) 100%);background-position:0 100%;background-repeat:repeat-x;background-size:4px 1px;margin-bottom:5px}.tag-cloud a:hover{background-size:4px 100px}.tag-cloud.tag-cloud-small a{font-size:1em;padding:6px}.repo{margin-top:15px;padding:20px;border-radius:10px;background-color:rgb(255,250,223);border-left:2px solid rgb(248,235,174);margin-bottom:20px}.book-ef-promo{padding:20px;border-radius:10px;background-color:rgb(218,229,241);border-left:2px solid rgb(200,213,228);margin-bottom:20px;margin-top:20px}code[class*="language-"],pre[class*="language-"]{color:#393A34;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;font-size:1.2em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre>code[class*="language-"]{font-size:1em}pre[class*="language-"]::selection,pre[class*="language-"] ::selection,code[class*="language-"]::selection,code[class*="language-"] ::selection{background:#C1DEF1}pre[class*="language-"]{padding:1em;margin:.5em 0;overflow:auto;border:1px solid #dddddd;background-color:white}:not(pre)>code[class*="language-"]{padding:.2em;padding-top:1px;padding-bottom:1px;background:#f8f8f8;border:1px solid #dddddd}.token.comment{color:#008000;font-style:italic}.token.string{color:#A31515}.token.punctuation,.token.operator{color:#393A34}.token.number,.token.boolean{color:#36acaa}.token.keyword{color:#0000ff}.token.function{color:#393A34}.token.class-name{color:#2B91AF}</style>
<link rel=alternate type=application/rss+xml title="Software development and beyond" href=https://stribny.name/blog/feed.xml>
<style>@font-face{font-family:"Source Sans Pro";font-style:normal;font-weight:400;src:url(data:font/woff2;base64,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)format("woff2");unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style>
<title>Async SQLAlchemy with FastAPI</title>
<link rel=icon type=image/png href="data:image/png;base64,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IHhtcE1NOkRvY3VtZW50SUQ9ImdpbXA6ZG9jaWQ6Z2ltcDoxODhmZDFlMi03NmRlLTRkNWUtYjIyMC1hNTdjODhiZmExOTgiCiAgIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6ZTVlZjBjN2YtZDRhZi00OGU0LWJiMmEtNDQ4ZGE2ZGIxNjdmIgogICB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6ZTMwYzhhMGItMmQ5OS00NzdiLTg1YzEtMjlhMjIzNWRmOTA5IgogICBkYzpGb3JtYXQ9ImltYWdlL3BuZyIKICAgR0lNUDpBUEk9IjIuMCIKICAgR0lNUDpQbGF0Zm9ybT0iTGludXgiCiAgIEdJTVA6VGltZVN0YW1wPSIxNjMxMTI5MzUwNzk3MzIzIgogICBHSU1QOlZlcnNpb249IjIuMTAuMjQiCiAgIHRpZmY6T3JpZW50YXRpb249IjEiCiAgIHhtcDpDcmVhdG9yVG9vbD0iR0lNUCAyLjEwIj4KICAgPHhtcE1NOkhpc3Rvcnk+CiAgICA8cmRmOlNlcT4KICAgICA8cmRmOmxpCiAgICAgIHN0RXZ0OmFjdGlvbj0ic2F2ZWQiCiAgICAgIHN0RXZ0OmNoYW5nZWQ9Ii8iCiAgICAgIHN0RXZ0Omluc3RhbmNlSUQ9InhtcC5paWQ6MjRkOTU0M2EtOTBjMi00ODRjLWE0MzUtMjhjOTY1ZDM0ZTA2IgogICAgICBzdEV2dDpzb2Z0d2FyZUFnZW50PSJHaW1wIDIuMTAgKExpbnV4KSIKICAgICAgc3RFdnQ6d2hlbj0iMjAyMS0wOS0wOFQyMToyOToxMCswMjowMCIvPgogICAgPC9yZGY6U2VxPgogICA8L3htcE1NOkhpc3Rvcnk+CiAgPC9yZGY6RGVzY3JpcHRpb24+CiA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgCjw/eHBhY2tldCBlbmQ9InciPz5Sx5u/AAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH5QkIEx0KQyDyJAAAABl0RVh0Q29tbWVudABDcmVhdGVkIHdpdGggR0lNUFeBDhcAAABISURBVGje7c8xDQAwCAAwwL+JJfgEFztI66D5eiYOqDhCRERERERERERERERERERERERERERERERERERERERERERERERE5I8F3XMDp33MGeoAAAAASUVORK5CYII="><meta http-equiv=content-security-policy content="default-src 'none'; font-src 'self' data:; img-src 'self' data:; style-src 'unsafe-inline'; media-src 'self' data:; script-src 'unsafe-inline' data:; object-src 'self' data:;"><style>img[src="data:,"],source[src="data:,"]{display:none!important}</style></head>
<body>
 <header>
 <p><a href=https://stribny.name/blog/ class=home-link>Software development and beyond</a></p>
 <nav class=main-nav>
 
 <div class=books-menu-opener>
 <a href=https://efficientdeveloper.com/>Books</a>
 <div class=books-menu-wrapper>
 <nav class=books-menu>
 <div class=books-menu-group>
 <div><a class=link-menu href=https://efficientdeveloper.com/>Efficient Developer</a></div>
 <div><a class=link-menu href=https://gum.co/moderncommandline>Command Line</a></div>
 </div>
 </nav>
 </div>
 </div>
 <div class=article-menu-opener>
 <a href=https://stribny.name/blog/>Articles</a>
 <div class=article-menu-wrapper>
 <nav class=article-menu>
 <div class=article-menu-group>
 <div><a class=link-menu href=https://stribny.name/blog/tag/popular>Popular</a></div>
 <div><a class=link-menu href=https://stribny.name/blog/tag/software-development>Development</a></div>
 <div><a class=link-menu href=https://stribny.name/blog/tag/development-tools>Tools</a></div>
 </div>
 <div class=article-menu-group>
 <div><a class=link-menu href=https://stribny.name/blog/tag/python>Python</a></div>
 <div><a class=link-menu href=https://stribny.name/blog/tag/javascript>JavaScript</a></div>
 <div><a class=link-menu href=https://stribny.name/blog/tag/testing>Testing</a></div>
 </div>
 <div class=article-menu-group>
 <div><a class=link-menu href=https://stribny.name/blog/tag/data>Data</a></div>
 <div><a class=link-menu href=https://stribny.name/blog/tag/ai>AI</a></div>
 <div><a class=link-menu href=https://stribny.name/blog/tag/devops>DevOps</a></div>
 </div>
 </nav>
 </div>
 </div>
 <a href=https://stribny.name/>Author</a>
 </nav>
 </header>
 <main class=wrapper>
 
<h1>Async SQLAlchemy with FastAPI</h1>
<p class=lead>
 
</p>
<h2>SQLAlchemy 1.4</h2>
<p>Before we look at the example, there are some important information about the new SQLAlchemy 1.4 release:</p>
<ul>
<li>SQLAlchemy 1.4 presents changes that will be finalized in SQLAlchemy 2.0.</li>
<li>SQLAlchemy unifies Core and ORM APIs for consistency.</li>
<li>Both Core and ORM now <a href=https://docs.sqlalchemy.org/en/14/orm/extensions/asyncio.html>support async with asyncio</a>, but this feature is not production ready yet. It also comes with some limitations on what can we do with the ORM, notably in respect to lazy loading.</li>
<li>There is a new way to create queries, called <a href=https://docs.sqlalchemy.org/en/14/glossary.html#term-1>2.0 style</a>, since it will be the style of the next major version of SQLAlchemy. Spoiler alert: the syntax is basically the same, but the query is not called on the session object directly.</li>
<li>There is now support for <a href=https://docs.sqlalchemy.org/en/14/orm/mapping_styles.html#declarative-mapping-with-dataclasses-and-attrs>declarative mapping with dataclasses and attrs</a>.</li>
</ul>
<p>In this post I will use the new async capabilities of the ORM layer, together with the new 2.0 style queries. We will create a simple FastAPI application with two routes. One for adding cities and their population, and another that will list the most populated entries.</p>
<h2>Prerequisites</h2>
<p>The example assumes Python 3.9 and SQLAlchemy 1.4. Other dependencies include FastAPI with uvicorn, <a href=https://github.com/MagicStack/asyncpg>asyncpg</a> (PostgreSQL database client for Python's asyncio) and <a href=https://stribny.name/blog/2020/01/building-command-line-interfaces-in-python/>typer</a> for creating the table structure from the command line.</p>
<p>The async support can be used only with PostgreSQL database at the moment.</p>
<div class=repo>
<p>The code for this article can be found in the <a href=https://github.com/stribny/fastapi-asyncalchemy/>stribny/fastapi-asyncalchemy</a> repo.</p>
</div>
<h2>Model</h2>
<p>There are new ways how to declare SQLAlchemy models, however I will use the subclass declarative style that still works well and is less verbose.</p>
<p>Our <code>City</code> model in <code>models.py</code> will have <code>id</code>, <code>name</code> and <code>population</code> fields:</p>
<pre class=language-python><code class=language-python><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Column<br><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> String<br><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Integer<br><span class="token keyword">from</span> fastapi_asyncalchemy<span class="token punctuation">.</span>db<span class="token punctuation">.</span>base <span class="token keyword">import</span> Base<br><br><br><span class="token keyword">class</span> <span class="token class-name">City</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span><br>    __tablename__ <span class="token operator">=</span> <span class="token string">"cities"</span><br><br>    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> autoincrement<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><br>    name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><br>    population <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">)</span></code></pre>
<h2>Async engine and model initialization</h2>
<p>In <code>base.py</code> we will initialize the new SQLAlchemy engine with <code>create_async_engine()</code> and create an async session maker by passing it the new <code>AsyncSession</code> class:</p>
<pre class=language-python><code class=language-python><span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>declarative <span class="token keyword">import</span> declarative_base<br><span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>asyncio <span class="token keyword">import</span> AsyncSession<br><span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>asyncio <span class="token keyword">import</span> create_async_engine<br><span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> sessionmaker<br><br><br>DATABASE_URL <span class="token operator">=</span> <span class="token string">"postgresql+asyncpg://postgres:postgres@localhost/asyncalchemy"</span><br><br><br>engine <span class="token operator">=</span> create_async_engine<span class="token punctuation">(</span>DATABASE_URL<span class="token punctuation">,</span> echo<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><br>Base <span class="token operator">=</span> declarative_base<span class="token punctuation">(</span><span class="token punctuation">)</span><br>async_session <span class="token operator">=</span> sessionmaker<span class="token punctuation">(</span><br>    engine<span class="token punctuation">,</span> class_<span class="token operator">=</span>AsyncSession<span class="token punctuation">,</span> expire_on_commit<span class="token operator">=</span><span class="token boolean">False</span><br><span class="token punctuation">)</span></code></pre>
<p>Specifying <code>echo=True</code> upon the engine initialization will enable us to see generated SQL queries in the console. We should disable the "expire on commit" behavior of sessions with <code>expire_on_commit=False</code>. This is because in async settings, we don't want SQLAlchemy to issue new SQL queries to the database when accessing already commited objects.</p>
<p>Let's also define an async function to clear and recreate the database table that we will use later:</p>
<pre class=language-python><code class=language-python><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">init_models</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><br>    <span class="token keyword">async</span> <span class="token keyword">with</span> engine<span class="token punctuation">.</span>begin<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span><br>        <span class="token keyword">await</span> conn<span class="token punctuation">.</span>run_sync<span class="token punctuation">(</span>Base<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>drop_all<span class="token punctuation">)</span><br>        <span class="token keyword">await</span> conn<span class="token punctuation">.</span>run_sync<span class="token punctuation">(</span>Base<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>create_all<span class="token punctuation">)</span></code></pre>
<p>Dropping and creating tables from <code>Base.metadata</code> doesn't run async by default and there is generally no reason for us to call it within an async function. This is just an example that shows how SQLAlchemy can run otherwise sync operations with <code>run_sync()</code>.</p>
<h2>Async session object</h2>
<p>Finally, we will create a FastAPI <a href=https://fastapi.tiangolo.com/tutorial/dependencies/>Dependency</a> function to create future sessions for us on demand:</p>
<pre class=language-python><code class=language-python><span class="token comment"># Dependency</span><br><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_session</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> AsyncSession<span class="token punctuation">:</span><br>    <span class="token keyword">async</span> <span class="token keyword">with</span> async_session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span><br>        <span class="token keyword">yield</span> session</code></pre>
<p>With FastAPI's dependency system we can later use this function to inject new sessions to our routes.</p>
<h2>Service layer and the new query style</h2>
<p>Let's now define two service functions in <code>service.py</code>: one for adding and another for retrieving cities.</p>
<pre class=language-python><code class=language-python><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> select<br><span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>asyncio <span class="token keyword">import</span> AsyncSession<br><span class="token keyword">from</span> fastapi_asyncalchemy<span class="token punctuation">.</span>models <span class="token keyword">import</span> <span class="token operator">*</span><br><br><br><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_biggest_cities</span><span class="token punctuation">(</span>session<span class="token punctuation">:</span> AsyncSession<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">list</span><span class="token punctuation">[</span>City<span class="token punctuation">]</span><span class="token punctuation">:</span><br>    result <span class="token operator">=</span> <span class="token keyword">await</span> session<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>select<span class="token punctuation">(</span>City<span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span>City<span class="token punctuation">.</span>population<span class="token punctuation">.</span>desc<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>limit<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token keyword">return</span> result<span class="token punctuation">.</span>scalars<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br><br><span class="token keyword">def</span> <span class="token function">add_city</span><span class="token punctuation">(</span>session<span class="token punctuation">:</span> AsyncSession<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> population<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span><br>    new_city <span class="token operator">=</span> City<span class="token punctuation">(</span>name<span class="token operator">=</span>name<span class="token punctuation">,</span> population<span class="token operator">=</span>population<span class="token punctuation">)</span><br>    session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>new_city<span class="token punctuation">)</span><br>    <span class="token keyword">return</span> new_city</code></pre>
<p>The <code>get_biggest_cities</code> uses the new <code>select</code> function to create the query. The query looks the same as it would be run directly on the session object. But now, instead of calling <code>session().query()</code>, we await <code>session.execute()</code> that will execute the query and hold the results. The <code>scalars()</code> method provides access to the results.</p>
<p>The function <code>add_city</code> just puts a new <code>City</code> object to the session - we will manage the transaction in the controller (route).</p>
<h2>Command line</h2>
<p>Before we look at the routes, we need to create our table. We will simply define a function in <code>main.py</code> that will run <code>init_models()</code> on the event loop. I used Typer to create the CLI command, although when only one command is defined, its execution is reduced to invoking <code>python main.py</code> without additional arguments.</p>
<pre class=language-python><code class=language-python><span class="token keyword">import</span> asyncio<br><span class="token keyword">import</span> typer<br><br>cli <span class="token operator">=</span> typer<span class="token punctuation">.</span>Typer<span class="token punctuation">(</span><span class="token punctuation">)</span><br><br><span class="token decorator annotation punctuation">@cli<span class="token punctuation">.</span>command</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token keyword">def</span> <span class="token function">db_init_models</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><br>    asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>init_models<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Done"</span><span class="token punctuation">)</span><br><br><br><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span><br>    cli<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<h2>Routes</h2>
<p>Let's now see the FastAPI routes (with <code>CitySchema</code> to represent the JSON exchanged):</p>
<pre class=language-python><code class=language-python><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<br><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> Depends<br><span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>asyncio <span class="token keyword">import</span> AsyncSession<br><span class="token keyword">from</span> pydantic <span class="token keyword">import</span> BaseModel<br><span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>exc <span class="token keyword">import</span> IntegrityError<br><span class="token keyword">from</span> fastapi_asyncalchemy<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> DuplicatedEntryError<br><span class="token keyword">from</span> fastapi_asyncalchemy<span class="token punctuation">.</span>db<span class="token punctuation">.</span>base <span class="token keyword">import</span> init_models<br><span class="token keyword">from</span> fastapi_asyncalchemy<span class="token punctuation">.</span>db<span class="token punctuation">.</span>base <span class="token keyword">import</span> get_session<br><span class="token keyword">from</span> fastapi_asyncalchemy <span class="token keyword">import</span> service<br><br><br>app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span><br><br><br><span class="token keyword">class</span> <span class="token class-name">CitySchema</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span><br>    name<span class="token punctuation">:</span> <span class="token builtin">str</span><br>    population<span class="token punctuation">:</span> <span class="token builtin">int</span><br><br><br><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/cities/biggest"</span><span class="token punctuation">,</span> response_model<span class="token operator">=</span><span class="token builtin">list</span><span class="token punctuation">[</span>CitySchema<span class="token punctuation">]</span><span class="token punctuation">)</span><br><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_biggest_cities</span><span class="token punctuation">(</span>session<span class="token punctuation">:</span> AsyncSession <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_session<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span><br>    cities <span class="token operator">=</span> <span class="token keyword">await</span> service<span class="token punctuation">.</span>get_biggest_cities<span class="token punctuation">(</span>session<span class="token punctuation">)</span><br>    <span class="token keyword">return</span> <span class="token punctuation">[</span>CitySchema<span class="token punctuation">(</span>name<span class="token operator">=</span>c<span class="token punctuation">.</span>name<span class="token punctuation">,</span> population<span class="token operator">=</span>c<span class="token punctuation">.</span>population<span class="token punctuation">)</span> <span class="token keyword">for</span> c <span class="token keyword">in</span> cities<span class="token punctuation">]</span><br><br><br><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/cities/"</span><span class="token punctuation">)</span><br><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">add_city</span><span class="token punctuation">(</span>city<span class="token punctuation">:</span> CitySchema<span class="token punctuation">,</span> session<span class="token punctuation">:</span> AsyncSession <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_session<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span><br>    city <span class="token operator">=</span> service<span class="token punctuation">.</span>add_city<span class="token punctuation">(</span>session<span class="token punctuation">,</span> city<span class="token punctuation">.</span>name<span class="token punctuation">,</span> city<span class="token punctuation">.</span>population<span class="token punctuation">)</span><br>    <span class="token keyword">try</span><span class="token punctuation">:</span><br>        <span class="token keyword">await</span> session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token keyword">return</span> city<br>    <span class="token keyword">except</span> IntegrityError <span class="token keyword">as</span> ex<span class="token punctuation">:</span><br>        <span class="token keyword">await</span> session<span class="token punctuation">.</span>rollback<span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token keyword">raise</span> DuplicatedEntryError<span class="token punctuation">(</span><span class="token string">"The city is already stored"</span><span class="token punctuation">)</span></code></pre>
<p>We can see that a session can be injected with <code>Depends</code>. So a call to each of the routes will create a new session. For retrieving data, the only change is that now we want to <code>await</code> our service function.</p>
<p>To demonstrate an error situation, I am catching an integrity error from the unique constraint defined earlier. We simply <code>await session.commit()</code> or <code>await session.rollback()</code>.</p>
<div class=book-ef-promo>
<p>Interested in efficient software development? In my upcoming book <a href=https://gumroad.com/l/efficientdeveloper>Efficient Developer</a> I cover topics like product specifications, development tools, processes, testing, and software estimation.</p>
<p>Check it out!</p>
</div>
<h2>Final words</h2>
<p>I am not an expert on asynchronous usage of SQLAlchemy, I just wanted to see what it would take to convert a standard FastAPI application with SQLAlchemy to the async world. Let me know on twitter if there is anything to add or change.</p>
<p>Last updated on 31.3.2021.</p>
<div class="tag-cloud tag-cloud-small">
 
 <a href=https://stribny.name/blog/tag/fastapi/>fastapi</a>
 
 <a href=https://stribny.name/blog/tag/python/>python</a>
 
 <a href=https://stribny.name/blog/tag/sqlalchemy/>sqlalchemy</a>
</div>
 </main>
 <footer>
 <div>
 <div class=wrapper>
 <nav>
 <div class=footer-book>
 <h3>Books</h3>
 <a class=footer-link href=https://efficientdeveloper.com/>Efficient Developer</a><br>
 <a class=footer-link href=https://stribny.name/blog/fastapi-asyncalchemy/>Command Line: A Modern Introduction</a>
 <h3>Stay in touch</h3>
 <a class=footer-link href=https://twitter.com/stribny>Follow me on Twitter</a><br>
 <a class=footer-link href=https://stribny.name/blog/feed.xml>Subscribe to RSS feed</a>
 </div>
 <div class=footer-name>
 <a href=https://stribny.name/>Petr Stribny</a>
 </div>
 </nav>
 </div>
 </div>
</footer>
<div style=display:block;opacity:1;color-scheme:light><template shadowroot=open><iframe allowtransparency=true frameborder=0 scrolling=no class=sk_ui title=Surfingkeys style=position:fixed;left:0px;bottom:0px;width:100%;height:0px;z-index:2147483647></iframe></template></div><script data-template-shadow-root>(()=>{document.currentScript.remove();processNode(document);function processNode(node){node.querySelectorAll("template[shadowroot]").forEach(element=>{let shadowRoot = element.parentElement.shadowRoot;if (!shadowRoot) {try {shadowRoot=element.parentElement.attachShadow({mode:element.getAttribute("shadowroot")});shadowRoot.innerHTML=element.innerHTML;element.remove()} catch (error) {} if (shadowRoot) {processNode(shadowRoot)}}})}})()</script>