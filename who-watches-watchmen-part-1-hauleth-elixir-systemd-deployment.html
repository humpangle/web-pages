<!DOCTYPE html> <html lang=en data-hint_scrollable=true style><!--
 Page saved with SingleFile
 url: https://hauleth.dev/post/who-watches-watchmen-i/
 saved date: Fri Jan 13 2023 03:31:49 GMT+0100 (Central European Standard Time)
--><meta charset=utf-8><title>Who Watches Watchmen? - Part 1 - Hauleth</title><meta content="width=device-width,initial-scale=1.0,maximum-scale=1" name=viewport><meta content="Blog about BEAM, Rust, fantasy &amp; stuff" name=description><meta content="Hauleth's blog -&nbsp;Who Watches Watchmen? - Part 1" property=og:title><meta content=website property=og:type><meta content=https://hauleth.dev/post/who-watches-watchmen-i/ property=og:url><meta content="A lot of application use systems like Kubernetes for their deployment. In my
humble opinion it is often overkill as system, that offers most of the stuff such
thing provide, is already present in your OS. In this article I will try to
present how to utilise the most popular system supervisor from Elixir
applications.
" property=og:description><meta content=https://hauleth.dev/banner.png property=og:image><meta content=@hauleth name=twitter:site><meta content=@hauleth name=twitter:creator><link href=https://webmention.io/hauleth.dev/webmention rel=webmention><style>.header{display:flex;flex-direction:column;position:relative}.header__inner{display:flex;align-items:center;justify-content:space-between}.header__logo{display:flex;flex:1}.header__logo:after{content:"";background:repeating-linear-gradient(90deg,var(--accent),var(--accent) 2px,transparent 0,transparent 10px);display:block;width:100%;right:10px}.header__logo a{flex:0 0 auto;max-width:100%;text-decoration:none}.header .menu{margin:20px 0;--shadow-color:var(--accent-alpha-70);--shadow:0 10px var(--shadow-color),-10px 10px var(--shadow-color),10px 10px var(--shadow-color)}@media (max-width:899px){.header .menu{margin-bottom:0}}.header .menu__inner{display:flex;flex-wrap:wrap;list-style:none;margin:0;padding:0}.header .menu__inner li:not(:last-of-type){margin-right:20px;margin-bottom:10px;flex:0 0 auto}@media (max-width:683px){.header .menu__inner{align-items:flex-start;padding:0}.header .menu__inner li{margin:0;padding:5px}}.logo{display:flex;align-items:center;text-decoration:none;background:var(--accent);color:black;padding:5px 10px}html{box-sizing:border-box}*,*:before,*:after{box-sizing:inherit}body{margin:0;padding:0;font-family:ui-monospace,monospace;font-size:12pt;line-height:1.54;background-color:var(--background);color:var(--color);text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-webkit-overflow-scrolling:touch;-webkit-text-size-adjust:100%}h1,h2,h3{line-height:1.3}h1:not(:first-child),h2:not(:first-child),h3:not(:first-child),h4:not(:first-child),h5:not(:first-child),h6:not(:first-child){margin-top:40px}h2 .zola-anchor,h3 .zola-anchor{font-size:.75em;visibility:hidden;margin-left:0.5rem;vertical-align:1%;text-decoration:none;border-bottom-color:transparent;cursor:pointer;color:var(--accent)}@media (hover:none){h2 .zola-anchor,h3 .zola-anchor{visibility:visible}}h1:hover .zola-anchor,h2:hover .zola-anchor,h3:hover .zola-anchor,h4:hover .zola-anchor,h5:hover .zola-anchor,h6:hover .zola-anchor{visibility:visible}h1{font-size:1.4rem}h2{font-size:1.3rem}h3{font-size:1.2rem}a{color:inherit}p{margin-bottom:20px}code{font-family:ui-monospace,monospace;background:var(--accent-alpha-20);color:var(--accent);padding:1px 6px;margin:0 2px;font-size:.95rem}pre{font-family:ui-monospace,monospace;padding:20px 10px;font-size:.95rem;overflow:auto;border-top:1px solid rgba(255,255,255,0.1);border-bottom:1px solid rgba(255,255,255,0.1);position:relative}pre+pre{border-top:0;margin-top:-40px}@media (max-width:683px){pre{white-space:pre-wrap;word-wrap:break-word}}pre[data-lang]::before{content:attr(data-lang);display:block;position:absolute;top:0;right:0;padding:.2em .5em;font-weight:bold;font-size:.95rem;border-radius:0 0 0 6px;background-color:var(--accent-alpha-20)}pre code{background:none!important;margin:0;padding:0;font-size:inherit;border:none}ul,ol{margin-left:30px;padding:0}ul li,ol li{padding-left:1em;margin-top:5px;margin-bottom:5px}@media (max-width:683px){ul,ol{margin-left:20px}}.container{display:flex;flex-direction:column;padding:40px;max-width:864px;min-height:100vh;border-right:1px solid rgba(255,255,255,0.1)}.container.center{border:none;margin:0 auto}@media (max-width:683px){.container{padding:20px}}.content{display:flex;flex-direction:column}hr{width:100%;border:none;background:var(--border-color);height:1px}ol{counter-reset:li;list-style:none}ol li{counter-increment:li}ol li::before{content:counters(li,".")". "}.halmos{text-align:right;font-size:1.5em}.post{width:100%;text-align:left;margin:20px auto;padding:20px 0 0 0}@media (max-width:899px){.post{margin:0 auto;max-width:660px}}.post:first-of-type{padding-top:0}.post:not(:last-of-type){border-bottom:1px solid var(--border-color)}.post-meta{margin-bottom:10px;color:var(--accent-alpha-70)}.post-meta a{text-decoration:none}.post-meta a:hover{text-decoration:underline}.post-title{--border:3px dotted var(--accent);position:relative;color:var(--accent);margin:0 0 15px;padding-bottom:15px;border-bottom:var(--border)}.post-title:after{content:"";position:absolute;bottom:2px;display:block;width:100%;border-bottom:var(--border)}.post-title a{text-decoration:none}.post-content{margin-top:30px}.post ul{list-style:"â¦¿"}.post-toc{font-size:.8rem}.post-toc label{color:var(--accent-alpha-70);-webkit-user-select:none;-ms-user-select:none;user-select:none}.post-toc label::before{content:">";margin-right:1rem}.webmentions .url-only{line-break:anywhere}.pagination{margin-top:50px}.pagination__buttons{display:flex;align-items:center;justify-content:center}.footer{padding:40px 0;flex-grow:0;opacity:.5}.footer__inner{display:flex;align-items:center;justify-content:space-between;margin:0;width:760px;max-width:100%}@media (max-width:899px){.footer__inner{flex-direction:column}}.footer a{color:inherit}.footer .copyright{width:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--accent-alpha-70)}.footer .copyright>*:first-child:not(:only-child){margin-right:10px}@media (max-width:899px){.footer .copyright>*:first-child:not(:only-child){margin:0}}@media (max-width:899px){.footer .copyright{margin-top:10px}}:root{--phoneWidth: (max-width: 684px);--tabletWidth: (max-width: 900px)}.z-code{color:#d8dee9;background-color:#2e3440}.z-comment,.z-punctuation.z-definition.z-comment{color:#616e88}.z-constant.z-numeric{color:#b48ead}.z-constant.z-language{color:#81a1c1}.z-constant.z-other{color:#d8dee9}.z-entity.z-name.z-class{color:#8fbcbb}.z-entity.z-name.z-function{color:#88c0d0}.z-keyword.z-control{color:#81a1c1}.z-keyword.z-other{color:#81a1c1}.z-keyword.z-operator,.z-keyword.z-operator.z-assignment{color:#81a1c1}.z-punctuation.z-separator{color:#eceff4}.z-storage.z-type{color:#81a1c1}.z-string.z-quoted.z-double{color:#a3be8c}.z-punctuation.z-definition.z-string.z-begin,.z-punctuation.z-definition.z-string.z-end{color:#a3be8c}.z-support.z-constant{color:#8fbcbb}.z-variable.z-parameter{color:#d8dee9}:root{--accent:rgb(35,176,255);--accent-alpha-20:rgba(35,176,255,.2);--accent-alpha-70:rgba(35,176,255,.7);--background:#1D1E28;--color:whitesmoke;--border-color:rgba(255,255,255,.1)}</style><link title="Hauleth's blog Feed" href=https://hauleth.dev/atom.xml rel=alternate type=application/atom+xml><link rel="shortcut icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgEAIAAACsiDHgAAABgWlDQ1BzUkdCIElFQzYxOTY2LTIuMQAAKJF1kc8rRFEUxz8zg/EzioWFxaRhNcTIxEaZSUNNmsYog83Mm19qfrzeG0m2ynaKEhu/FvwFbJW1UkRKlrImNug5z6iZZM7t3PO533vP6d5zwRrOKFm9ZgCyuYIW8nsdc5F5h/2JOuw0MIw7qujqeDAYoKq932Ix43WfWav6uX+tKZ7QFbDUC48pqlYQnhQOrBRUk7eEO5R0NC58IuzS5ILCN6YeK/GzyakSf5qshUM+sLYJO1IVHKtgJa1lheXlOLOZZeX3PuZLmhO52RmJ3eJd6ITw48XBFBP48DDIqMwe+nDTLyuq5A/85E+Tl1xFZpVVNJZIkaaAS9RlqZ6QmBQ9ISPDqtn/v33Vk0PuUvVmL9Q+GsZrD9g34atoGB8HhvF1CLYHOM+V8/P7MPImerGsOfegdR1OL8pabBvONqDzXo1q0R/JJm5NJuHlGFoi0H4FjQulnv3uc3QH4TX5qkvY2YVeOd+6+A2Ke2f2402ICQAAAAlwSFlzAAALEwAACxMBAJqcGAAABAxJREFUWIVjVFbesOH/f4YhC5gG2gGUglEPDDRgoadl/6p/Jnz9+mHfOtuuLhSJLCZRZmah2HC/ujpSzaSrBz592hkya9b7JSvnNDWhSIQwl7GyCjGEM5DuATolof+cv9V+/vzAumF+Tw91TaZTDHzm2X9v0aK/2e/+PnsGEWHW5n8vLs5X4XkwM5PBkimZiYmBgcGKdJNp7oH/RX+t/vx5L7V2SUcHQyBCXOBPYEJJiUBDQGJJCUMDw1xyzad5EvqifjRz1ao/gS+L7t2DWhnOfVxQkC/EQyAjg3LzaeiB/zv/z/33773B6oq2NmRxfh/fl/n5TCs4Anl4KLeFhh74lnJq6ebNv0Uem169ChFhXM4RwMPDz+rTnptLLVtokgf+3/nv9///e7/Vu1tbkcX5KzwPZmYys/DMFxKill00iYHvRy9N2bv35+Y77qdPQ4W+sdxkZ+ef5OdTWEhdu2gSA+95Vx9DDXu+RpfnSUksawSDJSWpaxeVY+AH043zx4790L+y4sABqJAloyLjEgHnoMNlZdS1CwKo7IH3GqtD20JQhI7/v/8/5u/G9/EvXlDXLgigmgd+tj3Iv3jx2+azOlufY8q+YZ3TkZ8PKVipZSMEUM0D74PXaLa3owi5MEYxfoUwf064Pe3UqS/BBxyXLKGWjRBABQ/8Ovxs9a1bX9WPZK5ahSzOK+S0I8ECWeSt06IjFRX/In6s//KFcnshgAoe+DBrbU9nJ8NdBn9Y35rzteFjDw8RppQ5E48yFwoGwUqev/3v1z1//j4EI64oABR54M/d12aPHn3m3X9v0SJkccELoR1VVUynOZl4eYX3xdl0dCDLflDfENjb+zvgZSGsdUQJoMgDH1g2LOjpYSj+Z/3nD0SEI13LxdaWM0PL1dYWIsKz1mF/TAx7gWqWmRlUG9cf9Z8/396cv6G0lBLbIYBMD/z9/vHgq1efxHaxzp6NLC54IaSjqgpZhNGdMZmJSeR3SsXEicjiX7ec0F+37vvzSy779pHnBgggoSb+MHFz6oQJ/5/9Kv3x44fqzVnHj/93/P31xw+ILNtjpaVGRpwyhkbu7gwqDE9Q9XLsUD9nYcFzwaEgNvaLwYEJixdDxF9XzDycnc0r4XQrPp7BjTGZiUmQxCqPkfiBrfvhMSeEhf+1fel49w5TVnxzue6aNTwFls3BwbhM+OP+1uvp00dSWUvV1f/X/Ez8+hVFegNzGSurcvFaq1+/iPcAFUoh1ibp7Roa3JoWCoGB+FWy7BTeJi0teD4ULZlRAkhIQvw+vq/y8/+//lny7RuyOFeHga2bG+NCxp9MRAWHwFb/v0VF/87/6Pj6lWHavzd//0Il5JmEmJmJdw8EkJCEBicY8iNzox4YaAAAWqSHg/3nfrwAAAAASUVORK5CYII=" type=image/x-icon><style>.sf-hidden{display:none!important}</style><link rel=canonical href=https://hauleth.dev/post/who-watches-watchmen-i/><meta http-equiv=content-security-policy content="default-src 'none'; font-src 'self' data:; img-src 'self' data:; style-src 'unsafe-inline'; media-src 'self' data:; script-src 'unsafe-inline' data:; object-src 'self' data:;"><style>img[src="data:,"],source[src="data:,"]{display:none!important}</style><body><div class="container center"><header class=header><div class=header__inner><div class=header__logo><a href=https://hauleth.dev/> <div class=logo>~hauleth</div> </a></div></div><nav class=menu><ul class=menu__inner><li><a href=https://plan.cat/~hauleth rel=me>.plan</a><li><a href=https://twitter.com/hauleth rel=me>twitter</a><li><a href=https://fosstodon.org/@hauleth rel=me>mastodon</a><li><a href=https://github.com/hauleth rel=me>github</a><li><a href=https://gitlab.com/hauleth rel=me>gitlab</a></ul></nav></header><div class=content><article class="post h-entry"><h1 class="post-title p-name"><a href=https://hauleth.dev/post/who-watches-watchmen-i/ id=top>Who Watches Watchmen? - Part 1</a></h1><div class=post-meta><span class=post-date><time class=dt-published datetime=2022-01-17T21:22:18+01:00>2022.01.17</time></span> :: #<a class=p-category href=https://hauleth.dev/tags/elixir/>elixir</a> #<a class=p-category href=https://hauleth.dev/tags/programming/>programming</a> #<a class=p-category href=https://hauleth.dev/tags/systemd/>systemd</a> #<a class=p-category href=https://hauleth.dev/tags/deployment/>deployment</a></div><div class=post-toc><label for=toc-toggle>Table of content</label><input hidden id=toc-toggle type=checkbox class=sf-hidden><div class="toggleable sf-hidden"></div></div><div class="post-content e-content"><p>I gave talk about this topic on CODE Beam V Americas, but I wasn't really satisfied with it. In this post I will try to describe what my presentation was meant to be about.<p>If you are wondering about the presentation, <a href=https://speakerdeck.com/hauleth/who-supervises-supervisors>the slides are on SpeakerDeck</a>.<h2 id=abstract>Abstract<a aria-label="Anchor link for: abstract" class=zola-anchor href=#abstract>#</a></h2><p>Most of the operating systems are multi-process and multi-user operating systems. This has a lot of positive aspects, like to be able to do more than one thing at the time at our devices, but it introduces a lot of complexities that in most cases are hidden from the users and developers. These things still need to be handled in one or another way. The most basic problems are:<ul><li>some processes need to be started before user can interact with the OS in meaningful (for them) way (for example mounting filesystems, logging, etc.)<li>some processes require strict startup ordering, for example you may need logging to be started before starting HTTP server<li>system operator somehow need to know when the process is ready to do their work, which is often some time after process start<li>system operator should be able to check process state in case when debugging is needed, most commonly via logs<li>shutdown of the processes should be handled in a way, that will allow other processes to be shut down cleanly (for example application that uses DB should be down before DB itself)</ul><h2 id=why-we-need-system-supervisor>Why we need system supervisor?<a aria-label="Anchor link for: why-we-need-system-supervisor" class=zola-anchor href=#why-we-need-system-supervisor>#</a></h2><p>System supervisor is a process started early in the OS boot, that should handle starting and managing all other processes that will be run on our system. It is often the init process (first process started by the OS that is running with PID 1) or it is first (and sometimes only) process started by the init process. Popular examples of such supervisors (often integrated with init systems):<ul><li>SysV which is "traditional" implementation that originates at UNIX System V (hence the name)<li>BSD init that with some variations is used in BSD-based OSes (NetBSD, FreeBSD), it shares some similarities to SysV init and services description is provided by shell scripts<li>OpenRC that also uses shell-based scripts for service description, used by Linux distributions like Gentoo or Alpine<li><code>launchd</code> that is used on Darwin (macOS, iPadOS, iOS, watchOS) systems that uses XML-based <code>plists</code> for services description<li><code>runit</code> which is small init and supervisor, but quite capable, for example used by Void Linux<li>Upstart created by Canonical Ltd. as a replacement for SysV-like init system in Ubuntu (no longer in use in Ubuntu), still used in some distributions like ChromeOS or Synology NAS<li><code>systemd</code> (this is the name, not "SystemD") that was created by Red Hat employee, (in)famous Lennart Poettering, and later was adopted by almost all major Linux distributions which spawned some heated discussion about it</ul><p>In this article I will focus on systemd, and its approach to "new-style system daemons".<hr><p><strong>DISCLAIMER</strong><p>Each of the solutions mentioned above has its strong and weak points. I do not want to start another flame war whether it is good or not. It has some good in it, and it has some bad in it, but we can say that it "won" over the most used distributions, and despite our love or hate towards it, we need to learn how to live with that.<hr><h2 id=why-systemd>Why <code>systemd</code>?<a aria-label="Anchor link for: why-systemd" class=zola-anchor href=#why-systemd>#</a></h2><p><code>systemd</code> became a thing because SysV approach to ordering services' startup was mildly irritating and non-parallelizable. In short, SysV is starting processes exactly in lexicographical order of files in given directory. This meant, that even if your service didn't need the DB at all, but it somehow ended further in the directory listing, you ended in waiting for the DB startup. Additionally, SysV wasn't really monitoring services, it just assumed that when process forked itself to the background, then it is "done" with the startup, and we can continue. This is obviously not true in many cases, for example, if your previous shutdown wasn't clean because of power shortage or other issue, then your DB probably need a bit of time to rebuild state from journal. This causes even more slowdown for the processes further in the list. This is highly undesired in modern, cloud-based, environment, where you can often start the machines on-demand during autoscaling actions. When there is a spike in the traffic that need autoscaling, then the sooner new machine is in usable state the sooner it can take load from other machines.<p>Different tools take different approach to solve that issue there. <code>systemd</code> take approach that is derived from <code>launchd</code> - do not do stuff, that is not needed. We can trigger on action of other services (obviously), but also on stuff like socket activity, path creation/modification, mounts, connection or disconnection of device, time events, etc.<hr><p><strong>DIGRESSION</strong><p>This is exactly the reason why <code>systemd</code> has its infamous "feature creep", it doesn't "digest" all services like Cron or <code>udev</code>. It is not that these are "tightly" intertwined into <code>systemd</code>. You can still replace them with their older counterparts, you will just lose all the features these bring with them.<hr><p>Such lazy approach sometimes require changes into the service itself. For example to let supervisor know, that you are ready (not just started), you need some way to communicate with supervisor. In <code>systemd</code> you can do so via UNIX socket pointed by <code>NOTIFY_SOCKET</code> environment variable passed to your application. With the same socket you can implement another useful feature - watchdog/heartbeat process. This mean that if for any reason your process became non-responsive (but it will refuse to die), then supervisor will forcefully bring process down and restart it, assuming that the error was accidental.<p>About restarting, we can define behaviour of service after main process die. It can be restarted regardless of the exit code, it can be restarted on abnormal exit, it can remain shut, etc. Does this ring a bell? This works similarly to OTP supervisors, but "one level above". If your service utilize system supervisor right, you can make your application almost ultimately self-healing (by restarts).<h2 id=basic-setup>Basic setup<a aria-label="Anchor link for: basic-setup" class=zola-anchor href=#basic-setup>#</a></h2><p>Now, when we know a little about how and why <code>systemd</code> works as it works, we now can go to details on how to utilize that with services in Elixir.<p>As a base we will implement super simple Plug application:<pre class="language-elixir z-code" data-lang=elixir><code class=language-elixir data-lang=elixir><span class="z-source z-elixir"><span class="z-comment z-line z-number-sign z-elixir"><span class="z-punctuation z-definition z-comment z-elixir">#</span> hello/application.ex
</span><span class="z-meta z-module z-elixir"><span class="z-keyword z-control z-module z-elixir">defmodule</span> <span class="z-entity z-name z-class z-elixir">Hello</span>.<span class="z-entity z-name z-class z-elixir">Application</span> <span class="z-keyword z-control z-module z-elixir">do</span></span>
  <span class="z-keyword z-control z-elixir">use</span> <span class="z-entity z-name z-class z-elixir">Application</span>

<span class="z-meta z-function z-elixir">  <span class="z-keyword z-control z-module z-elixir">def</span> <span class="z-entity z-name z-function z-public z-elixir">start</span><span class="z-punctuation z-definition z-parameters z-elixir">(</span>_type<span class="z-punctuation z-separator z-object z-elixir">,</span> _opts<span class="z-punctuation z-section z-function z-elixir">)</span> <span class="z-keyword z-control z-module z-elixir">do</span></span>
    children <span class="z-keyword z-operator z-assignment z-elixir">=</span> <span class="z-punctuation z-section z-array z-elixir">[</span>
      <span class="z-meta z-sequence z-tuple z-elixir"><span class="z-punctuation z-section z-sequence z-begin z-elixir">{</span><span class="z-entity z-name z-class z-elixir">Plug</span><span class="z-punctuation z-separator z-method z-elixir">.</span><span class="z-entity z-name z-class z-elixir">Cowboy</span><span class="z-punctuation z-separator z-sequence z-elixir">,</span> <span class="z-punctuation z-section z-array z-elixir">[</span><span class="z-constant z-other z-keywords z-elixir">scheme<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-constant z-other z-symbol z-elixir"><span class="z-punctuation z-definition z-constant z-elixir">:</span>http</span><span class="z-punctuation z-separator z-sequence z-elixir">,</span> <span class="z-constant z-other z-keywords z-elixir">plug<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-entity z-name z-class z-elixir">Hello</span><span class="z-punctuation z-separator z-method z-elixir">.</span><span class="z-entity z-name z-class z-elixir">Router</span><span class="z-punctuation z-section z-array z-elixir">]</span> <span class="z-keyword z-operator z-list-manipulation z-elixir">++</span> cowboy_opts<span class="z-punctuation z-section z-function z-elixir">(</span><span class="z-punctuation z-section z-function z-elixir">)</span><span class="z-punctuation z-section z-sequence z-end z-elixir">}</span></span><span class="z-punctuation z-separator z-object z-elixir">,</span>
      <span class="z-meta z-sequence z-tuple z-elixir"><span class="z-punctuation z-section z-sequence z-begin z-elixir">{</span><span class="z-entity z-name z-class z-elixir">Plug</span><span class="z-punctuation z-separator z-method z-elixir">.</span><span class="z-entity z-name z-class z-elixir">Cowboy</span><span class="z-punctuation z-separator z-method z-elixir">.</span><span class="z-entity z-name z-class z-elixir">Drainer</span><span class="z-punctuation z-separator z-sequence z-elixir">,</span> <span class="z-constant z-other z-keywords z-elixir">refs<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-constant z-other z-symbol z-elixir"><span class="z-punctuation z-definition z-constant z-elixir">:</span>all</span><span class="z-punctuation z-section z-sequence z-end z-elixir">}</span></span>
    <span class="z-punctuation z-section z-array z-elixir">]</span>

    <span class="z-entity z-name z-class z-elixir">Supervisor</span><span class="z-punctuation z-separator z-method z-elixir">.</span>start_link<span class="z-punctuation z-section z-function z-elixir">(</span>children<span class="z-punctuation z-separator z-object z-elixir">,</span> <span class="z-constant z-other z-keywords z-elixir">strategy<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-constant z-other z-symbol z-elixir"><span class="z-punctuation z-definition z-constant z-elixir">:</span>one_for_one</span><span class="z-punctuation z-section z-function z-elixir">)</span>
  <span class="z-keyword z-control z-elixir">end</span>

<span class="z-meta z-function z-elixir">  <span class="z-keyword z-control z-module z-elixir">defp</span> <span class="z-entity z-name z-function z-private z-elixir">cowboy_opts</span> <span class="z-keyword z-control z-module z-elixir">do</span></span>
    <span class="z-punctuation z-section z-array z-elixir">[</span>
      <span class="z-constant z-other z-keywords z-elixir">port<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-entity z-name z-class z-elixir">String</span><span class="z-punctuation z-separator z-method z-elixir">.</span>to_integer<span class="z-punctuation z-section z-function z-elixir">(</span><span class="z-entity z-name z-class z-elixir">System</span><span class="z-punctuation z-separator z-method z-elixir">.</span>get_env<span class="z-punctuation z-section z-function z-elixir">(</span><span class="z-meta z-string z-elixir"><span class="z-string z-quoted z-double z-elixir"><span class="z-punctuation z-definition z-string z-begin z-elixir">"</span>PORT<span class="z-punctuation z-definition z-string z-end z-elixir">"</span></span></span><span class="z-punctuation z-separator z-object z-elixir">,</span> <span class="z-meta z-string z-elixir"><span class="z-string z-quoted z-double z-elixir"><span class="z-punctuation z-definition z-string z-begin z-elixir">"</span>4000<span class="z-punctuation z-definition z-string z-end z-elixir">"</span></span></span><span class="z-punctuation z-section z-function z-elixir">)</span><span class="z-punctuation z-section z-function z-elixir">)</span>
    <span class="z-punctuation z-section z-array z-elixir">]</span>
  <span class="z-keyword z-control z-elixir">end</span>
<span class="z-keyword z-control z-elixir">end</span>
</span></code></pre><pre class="language-elixir z-code" data-lang=elixir><code class=language-elixir data-lang=elixir><span class="z-source z-elixir"><span class="z-comment z-line z-number-sign z-elixir"><span class="z-punctuation z-definition z-comment z-elixir">#</span> hello/router.ex
</span><span class="z-meta z-module z-elixir"><span class="z-keyword z-control z-module z-elixir">defmodule</span> <span class="z-entity z-name z-class z-elixir">Hello</span>.<span class="z-entity z-name z-class z-elixir">Router</span> <span class="z-keyword z-control z-module z-elixir">do</span></span>
  <span class="z-keyword z-control z-elixir">use</span> <span class="z-entity z-name z-class z-elixir">Plug</span><span class="z-punctuation z-separator z-method z-elixir">.</span><span class="z-entity z-name z-class z-elixir">Router</span>

  plug <span class="z-constant z-other z-symbol z-elixir"><span class="z-punctuation z-definition z-constant z-elixir">:</span>match</span>
  plug <span class="z-constant z-other z-symbol z-elixir"><span class="z-punctuation z-definition z-constant z-elixir">:</span>dispatch</span>

  get <span class="z-meta z-string z-elixir"><span class="z-string z-quoted z-double z-elixir"><span class="z-punctuation z-definition z-string z-begin z-elixir">"</span>/<span class="z-punctuation z-definition z-string z-end z-elixir">"</span></span></span> <span class="z-keyword z-control z-elixir">do</span>
    send_resp<span class="z-punctuation z-section z-function z-elixir">(</span>conn<span class="z-punctuation z-separator z-object z-elixir">,</span> <span class="z-constant z-numeric z-elixir">200</span><span class="z-punctuation z-separator z-object z-elixir">,</span> <span class="z-meta z-string z-elixir"><span class="z-string z-quoted z-double z-elixir"><span class="z-punctuation z-definition z-string z-begin z-elixir">"</span>Hello World!<span class="z-punctuation z-definition z-string z-end z-elixir">"</span></span></span><span class="z-punctuation z-section z-function z-elixir">)</span>
  <span class="z-keyword z-control z-elixir">end</span>
<span class="z-keyword z-control z-elixir">end</span>
</span></code></pre><p>I will also assume that we are using <a href=https://hexdocs.pm/mix/Mix.Tasks.Release.html>Mix release</a> named <code>hello</code> that we later copy to <code>/opt/hello</code>.<h3 id=systemd-unit-file>systemd unit file<a aria-label="Anchor link for: systemd-unit-file" class=zola-anchor href=#systemd-unit-file>#</a></h3><p>We have only one thing left, we need to define our <a href=https://www.freedesktop.org/software/systemd/man/systemd.service.html#><code>hello.service</code></a>:<pre class="language-ini z-code" data-lang=ini><code class=language-ini data-lang=ini><span class="z-source z-genconfig"><span class="z-storage z-type z-genconfig">[Unit]
</span><span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">Description</span><span class="z-keyword z-operator z-genconfig">=</span></span>Hello World service

<span class="z-storage z-type z-genconfig">[Service]
</span><span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">Environment</span><span class="z-keyword z-operator z-genconfig">=</span></span><span class="z-support z-constant z-genconfig">PORT</span><span class="z-keyword z-operator z-genconfig">=</span><span class="z-constant z-numeric z-genconfig">80</span>
<span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">ExecStart</span><span class="z-keyword z-operator z-genconfig">=</span></span><span class="z-keyword z-operator z-genconfig">/</span>opt<span class="z-keyword z-operator z-genconfig">/</span>hello<span class="z-keyword z-operator z-genconfig">/</span>bin<span class="z-keyword z-operator z-genconfig">/</span>hello <span class="z-keyword z-other z-genconfig">start</span>
</span></code></pre><p>Now you can create file with that content in <code>/usr/local/lib/systemd/system/hello.service</code> and then start it with:<pre class=z-code><code><span class="z-text z-plain"># systemctl start hello.service
</span></code></pre><p>This is the simplest service imaginable, however from the start we have few issues there:<ul><li>It will run service as user running supervisor, so if it is run using global supervisor, then it will run as <code>root</code>. You do not want to run anything as <code>root</code>.<li>On error it will produce (BEAM) core dump, which may contain sensitive data.<li>It can read (and, due to being run as <code>root</code>, write) everything in the system, like private data of other processes.</ul><h2 id=service-readiness>Service readiness<a aria-label="Anchor link for: service-readiness" class=zola-anchor href=#service-readiness>#</a></h2><p>Erlang VM isn't really the best tool out there wrt the startup times. In addition to that our application may need some preparation steps before it can be marked as "ready". This is problem that I sometimes encounter in Docker, where some containers do not really have any health check, and then I need to have loop with check in some of the containers that depend on another one. This "workaround" is frustrating, error prone, and can cause nasty Heisenbugs when the timing will be wrong.<p>Two possible solutions for this problem are:<ul><li>Readiness probe - another program that is ran after the main process is started, that checks whether our application is ready to work.<li>Notification system where our application uses some common protocol to inform the supervisor that it finished setup and is ready for work.</ul><p>systemd supports the second approach via <a href=https://www.freedesktop.org/software/systemd/man/sd_notify.html><code>sd_notify</code></a>. The approach there is simple - we have <code>NOTIFY_SOCKET</code> environment variable that contain path to the Unix datagram socket, that we can use to send informations about state of our application. This socket accept set of different messages, but right now, for our purposes, we will focus only on few of them:<ul><li><code>READY=1</code> - marks our service as ready, aka it is ready to do its work (for example accept incoming HTTP connections in our example). It need to be sent withing given timespan after start of the VM, otherwise the process will be killed and possibly restarted<li><code>STATUS=name</code> - sets status of our application that can be checked via <code>systemctl status hello.service</code>, this allows us to have better insight into what is the high level state without manually traversing through logs<li><code>RELOADING=1</code> - marks, that our application is reloading, which in general may mean a lot of things, but there it will be used to mark <code>:init.restart/0</code>-like behaviour (due to <a href=https://github.com/erlang/otp/issues/4698>erlang/otp#4698</a> there is wrapper for that function in <code>systemd</code> library). The process need then to send <code>READY=1</code> within given timespan, or the process will be marked as a malfunctioning, and will be forcefully killed and possibly restarted<li><code>STOPPING=1</code> - marks, that our application began shutting down process, and will be closing soon. If the process will not close within given timespan, it will be forcefully killed</ul><p>These messages provide us enough power to not only mark the service as ready, but also provides additional information about system state, so even operator, who knows a little about Erlang or our application runtime, will be able to understand what is going on.<p>The main thing is that systemd will wait with activation of the dependants of our system as well as the <code>systemctl start</code> and <code>systemctl restart</code> commands will wait until our service declare that it is ready.<p>Usage of such feature is quite simple:<pre class="language-ini z-code" data-lang=ini><code class=language-ini data-lang=ini><span class="z-source z-genconfig"><span class="z-storage z-type z-genconfig">[Unit]
</span><span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">Description</span><span class="z-keyword z-operator z-genconfig">=</span></span>Hello World service

<span class="z-storage z-type z-genconfig">[Service]
</span><span class="z-meta z-comment z-genconfig"><span class="z-comment z-line z-number-sign z-genconfig"># Define `Type=` to `notify`
</span></span><span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">Type</span><span class="z-keyword z-operator z-genconfig">=</span></span>notify
<span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">Environment</span><span class="z-keyword z-operator z-genconfig">=</span></span><span class="z-support z-constant z-genconfig">PORT</span><span class="z-keyword z-operator z-genconfig">=</span><span class="z-constant z-numeric z-genconfig">80</span>
<span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">ExecStart</span><span class="z-keyword z-operator z-genconfig">=</span></span><span class="z-keyword z-operator z-genconfig">/</span>opt<span class="z-keyword z-operator z-genconfig">/</span>hello<span class="z-keyword z-operator z-genconfig">/</span>bin<span class="z-keyword z-operator z-genconfig">/</span>hello <span class="z-keyword z-other z-genconfig">start</span>
<span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">WatchdogSec</span><span class="z-keyword z-operator z-genconfig">=</span></span><span class="z-constant z-numeric z-genconfig">1min</span>
</span></code></pre><p>And then in our supervisor tree we need add <code>:systemd.ready()</code> <strong>after</strong> last process needed for proper functioning of our application, in our simple example it is after <code>Plug.Cowboy</code>:<pre class="language-elixir z-code" data-lang=elixir><code class=language-elixir data-lang=elixir><span class="z-source z-elixir"><span class="z-comment z-line z-number-sign z-elixir"><span class="z-punctuation z-definition z-comment z-elixir">#</span> hello/application.ex
</span><span class="z-meta z-module z-elixir"><span class="z-keyword z-control z-module z-elixir">defmodule</span> <span class="z-entity z-name z-class z-elixir">Hello</span>.<span class="z-entity z-name z-class z-elixir">Application</span> <span class="z-keyword z-control z-module z-elixir">do</span></span>
  <span class="z-keyword z-control z-elixir">use</span> <span class="z-entity z-name z-class z-elixir">Application</span>

<span class="z-meta z-function z-elixir">  <span class="z-keyword z-control z-module z-elixir">def</span> <span class="z-entity z-name z-function z-public z-elixir">start</span><span class="z-punctuation z-definition z-parameters z-elixir">(</span>_type<span class="z-punctuation z-separator z-object z-elixir">,</span> _opts<span class="z-punctuation z-section z-function z-elixir">)</span> <span class="z-keyword z-control z-module z-elixir">do</span></span>
    children <span class="z-keyword z-operator z-assignment z-elixir">=</span> <span class="z-punctuation z-section z-array z-elixir">[</span>
      <span class="z-meta z-sequence z-tuple z-elixir"><span class="z-punctuation z-section z-sequence z-begin z-elixir">{</span><span class="z-entity z-name z-class z-elixir">Plug</span><span class="z-punctuation z-separator z-method z-elixir">.</span><span class="z-entity z-name z-class z-elixir">Cowboy</span><span class="z-punctuation z-separator z-sequence z-elixir">,</span> <span class="z-punctuation z-section z-array z-elixir">[</span><span class="z-constant z-other z-keywords z-elixir">scheme<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-constant z-other z-symbol z-elixir"><span class="z-punctuation z-definition z-constant z-elixir">:</span>http</span><span class="z-punctuation z-separator z-sequence z-elixir">,</span> <span class="z-constant z-other z-keywords z-elixir">plug<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-entity z-name z-class z-elixir">Hello</span><span class="z-punctuation z-separator z-method z-elixir">.</span><span class="z-entity z-name z-class z-elixir">Router</span><span class="z-punctuation z-section z-array z-elixir">]</span> <span class="z-keyword z-operator z-list-manipulation z-elixir">++</span> cowboy_opts<span class="z-punctuation z-section z-function z-elixir">(</span><span class="z-punctuation z-section z-function z-elixir">)</span><span class="z-punctuation z-section z-sequence z-end z-elixir">}</span></span><span class="z-punctuation z-separator z-object z-elixir">,</span>
      <span class="z-constant z-other z-symbol z-elixir"><span class="z-punctuation z-definition z-constant z-elixir">:</span>systemd</span><span class="z-punctuation z-separator z-method z-elixir">.</span>ready<span class="z-punctuation z-section z-function z-elixir">(</span><span class="z-punctuation z-section z-function z-elixir">)</span><span class="z-punctuation z-separator z-object z-elixir">,</span> <span class="z-comment z-line z-number-sign z-elixir"><span class="z-punctuation z-definition z-comment z-elixir">#</span> &lt;-- it is function call, as it returns proper
</span><span class="z-comment z-line z-number-sign z-elixir">                        <span class="z-punctuation z-definition z-comment z-elixir">#</span> `child_spec/0`
</span>      <span class="z-meta z-sequence z-tuple z-elixir"><span class="z-punctuation z-section z-sequence z-begin z-elixir">{</span><span class="z-entity z-name z-class z-elixir">Plug</span><span class="z-punctuation z-separator z-method z-elixir">.</span><span class="z-entity z-name z-class z-elixir">Cowboy</span><span class="z-punctuation z-separator z-method z-elixir">.</span><span class="z-entity z-name z-class z-elixir">Drainer</span><span class="z-punctuation z-separator z-sequence z-elixir">,</span> <span class="z-constant z-other z-keywords z-elixir">refs<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-constant z-other z-symbol z-elixir"><span class="z-punctuation z-definition z-constant z-elixir">:</span>all</span><span class="z-punctuation z-section z-sequence z-end z-elixir">}</span></span>
    <span class="z-punctuation z-section z-array z-elixir">]</span>

    <span class="z-entity z-name z-class z-elixir">Supervisor</span><span class="z-punctuation z-separator z-method z-elixir">.</span>start_link<span class="z-punctuation z-section z-function z-elixir">(</span>children<span class="z-punctuation z-separator z-object z-elixir">,</span> <span class="z-constant z-other z-keywords z-elixir">strategy<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-constant z-other z-symbol z-elixir"><span class="z-punctuation z-definition z-constant z-elixir">:</span>one_for_one</span><span class="z-punctuation z-section z-function z-elixir">)</span>
  <span class="z-keyword z-control z-elixir">end</span>

<span class="z-meta z-function z-elixir">  <span class="z-keyword z-control z-module z-elixir">defp</span> <span class="z-entity z-name z-function z-private z-elixir">cowboy_opts</span> <span class="z-keyword z-control z-module z-elixir">do</span></span>
    <span class="z-punctuation z-section z-array z-elixir">[</span>
      <span class="z-constant z-other z-keywords z-elixir">port<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-entity z-name z-class z-elixir">String</span><span class="z-punctuation z-separator z-method z-elixir">.</span>to_integer<span class="z-punctuation z-section z-function z-elixir">(</span><span class="z-entity z-name z-class z-elixir">System</span><span class="z-punctuation z-separator z-method z-elixir">.</span>get_env<span class="z-punctuation z-section z-function z-elixir">(</span><span class="z-meta z-string z-elixir"><span class="z-string z-quoted z-double z-elixir"><span class="z-punctuation z-definition z-string z-begin z-elixir">"</span>PORT<span class="z-punctuation z-definition z-string z-end z-elixir">"</span></span></span><span class="z-punctuation z-separator z-object z-elixir">,</span> <span class="z-meta z-string z-elixir"><span class="z-string z-quoted z-double z-elixir"><span class="z-punctuation z-definition z-string z-begin z-elixir">"</span>4000<span class="z-punctuation z-definition z-string z-end z-elixir">"</span></span></span><span class="z-punctuation z-section z-function z-elixir">)</span><span class="z-punctuation z-section z-function z-elixir">)</span>
    <span class="z-punctuation z-section z-array z-elixir">]</span>
  <span class="z-keyword z-control z-elixir">end</span>
<span class="z-keyword z-control z-elixir">end</span>
</span></code></pre><p>Now restarting our service will not finish immediately, but will wait until our service will declare that it is ready.<pre class=z-code><code><span class="z-text z-plain"># systemctl restart hello.service
</span></code></pre><p>About <code>STOPPING=1</code> - the magic thing is that the <code>systemd</code> library takes care of it for you. As soon as the system will be scheduled to shutdown this message will be automatically sent, and the operator will be notified about this fact.<p>We can also provide more information about state of our application. As you may have already noticed, we have <a href=https://hexdocs.pm/plug_cowboy/2.5.2/Plug.Cowboy.Drainer.html><code>Plug.Cowboy.Drainer</code></a> there. It is process that will delay shutdown of our application while there are still open connections. This can take some time, so it would be handy if the operator would see that the draining is in progress. We can easily achieve that by again changing our supervision tree to:<pre class="language-elixir z-code" data-lang=elixir><code class=language-elixir data-lang=elixir><span class="z-source z-elixir"><span class="z-comment z-line z-number-sign z-elixir"><span class="z-punctuation z-definition z-comment z-elixir">#</span> hello/application.ex
</span><span class="z-meta z-module z-elixir"><span class="z-keyword z-control z-module z-elixir">defmodule</span> <span class="z-entity z-name z-class z-elixir">Hello</span>.<span class="z-entity z-name z-class z-elixir">Application</span> <span class="z-keyword z-control z-module z-elixir">do</span></span>
  <span class="z-keyword z-control z-elixir">use</span> <span class="z-entity z-name z-class z-elixir">Application</span>

<span class="z-meta z-function z-elixir">  <span class="z-keyword z-control z-module z-elixir">def</span> <span class="z-entity z-name z-function z-public z-elixir">start</span><span class="z-punctuation z-definition z-parameters z-elixir">(</span>_type<span class="z-punctuation z-separator z-object z-elixir">,</span> _opts<span class="z-punctuation z-section z-function z-elixir">)</span> <span class="z-keyword z-control z-module z-elixir">do</span></span>
    children <span class="z-keyword z-operator z-assignment z-elixir">=</span> <span class="z-punctuation z-section z-array z-elixir">[</span>
      <span class="z-meta z-sequence z-tuple z-elixir"><span class="z-punctuation z-section z-sequence z-begin z-elixir">{</span><span class="z-entity z-name z-class z-elixir">Plug</span><span class="z-punctuation z-separator z-method z-elixir">.</span><span class="z-entity z-name z-class z-elixir">Cowboy</span><span class="z-punctuation z-separator z-sequence z-elixir">,</span> <span class="z-punctuation z-section z-array z-elixir">[</span><span class="z-constant z-other z-keywords z-elixir">scheme<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-constant z-other z-symbol z-elixir"><span class="z-punctuation z-definition z-constant z-elixir">:</span>http</span><span class="z-punctuation z-separator z-sequence z-elixir">,</span> <span class="z-constant z-other z-keywords z-elixir">plug<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-entity z-name z-class z-elixir">Hello</span><span class="z-punctuation z-separator z-method z-elixir">.</span><span class="z-entity z-name z-class z-elixir">Router</span><span class="z-punctuation z-section z-array z-elixir">]</span> <span class="z-keyword z-operator z-list-manipulation z-elixir">++</span> cowboy_opts<span class="z-punctuation z-section z-function z-elixir">(</span><span class="z-punctuation z-section z-function z-elixir">)</span><span class="z-punctuation z-section z-sequence z-end z-elixir">}</span></span><span class="z-punctuation z-separator z-object z-elixir">,</span>
      <span class="z-constant z-other z-symbol z-elixir"><span class="z-punctuation z-definition z-constant z-elixir">:</span>systemd</span><span class="z-punctuation z-separator z-method z-elixir">.</span>ready<span class="z-punctuation z-section z-function z-elixir">(</span><span class="z-punctuation z-section z-function z-elixir">)</span><span class="z-punctuation z-separator z-object z-elixir">,</span>
      <span class="z-constant z-other z-symbol z-elixir"><span class="z-punctuation z-definition z-constant z-elixir">:</span>systemd</span><span class="z-punctuation z-separator z-method z-elixir">.</span>set_status<span class="z-punctuation z-section z-function z-elixir">(</span><span class="z-constant z-other z-keywords z-elixir">down<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-punctuation z-section z-array z-elixir">[</span><span class="z-constant z-other z-keywords z-elixir">status<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-meta z-string z-elixir"><span class="z-string z-quoted z-double z-elixir"><span class="z-punctuation z-definition z-string z-begin z-elixir">"</span>drained<span class="z-punctuation z-definition z-string z-end z-elixir">"</span></span></span><span class="z-punctuation z-section z-array z-elixir">]</span><span class="z-punctuation z-section z-function z-elixir">)</span><span class="z-punctuation z-separator z-object z-elixir">,</span>
      <span class="z-meta z-sequence z-tuple z-elixir"><span class="z-punctuation z-section z-sequence z-begin z-elixir">{</span><span class="z-entity z-name z-class z-elixir">Plug</span><span class="z-punctuation z-separator z-method z-elixir">.</span><span class="z-entity z-name z-class z-elixir">Cowboy</span><span class="z-punctuation z-separator z-method z-elixir">.</span><span class="z-entity z-name z-class z-elixir">Drainer</span><span class="z-punctuation z-separator z-sequence z-elixir">,</span> <span class="z-constant z-other z-keywords z-elixir">refs<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-constant z-other z-symbol z-elixir"><span class="z-punctuation z-definition z-constant z-elixir">:</span>all</span><span class="z-punctuation z-separator z-sequence z-elixir">,</span> <span class="z-constant z-other z-keywords z-elixir">shutdown<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-constant z-numeric z-elixir">10_000</span><span class="z-punctuation z-section z-sequence z-end z-elixir">}</span></span><span class="z-punctuation z-separator z-object z-elixir">,</span>
      <span class="z-constant z-other z-symbol z-elixir"><span class="z-punctuation z-definition z-constant z-elixir">:</span>systemd</span><span class="z-punctuation z-separator z-method z-elixir">.</span>set_status<span class="z-punctuation z-section z-function z-elixir">(</span><span class="z-constant z-other z-keywords z-elixir">down<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-punctuation z-section z-array z-elixir">[</span><span class="z-constant z-other z-keywords z-elixir">status<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-meta z-string z-elixir"><span class="z-string z-quoted z-double z-elixir"><span class="z-punctuation z-definition z-string z-begin z-elixir">"</span>draining<span class="z-punctuation z-definition z-string z-end z-elixir">"</span></span></span><span class="z-punctuation z-section z-array z-elixir">]</span><span class="z-punctuation z-section z-function z-elixir">)</span>
    <span class="z-punctuation z-section z-array z-elixir">]</span>

    <span class="z-entity z-name z-class z-elixir">Supervisor</span><span class="z-punctuation z-separator z-method z-elixir">.</span>start_link<span class="z-punctuation z-section z-function z-elixir">(</span>children<span class="z-punctuation z-separator z-object z-elixir">,</span> <span class="z-constant z-other z-keywords z-elixir">strategy<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-constant z-other z-symbol z-elixir"><span class="z-punctuation z-definition z-constant z-elixir">:</span>one_for_one</span><span class="z-punctuation z-section z-function z-elixir">)</span>
  <span class="z-keyword z-control z-elixir">end</span>

<span class="z-meta z-function z-elixir">  <span class="z-keyword z-control z-module z-elixir">defp</span> <span class="z-entity z-name z-function z-private z-elixir">cowboy_opts</span> <span class="z-keyword z-control z-module z-elixir">do</span></span>
    <span class="z-punctuation z-section z-array z-elixir">[</span>
      <span class="z-constant z-other z-keywords z-elixir">port<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-entity z-name z-class z-elixir">String</span><span class="z-punctuation z-separator z-method z-elixir">.</span>to_integer<span class="z-punctuation z-section z-function z-elixir">(</span><span class="z-entity z-name z-class z-elixir">System</span><span class="z-punctuation z-separator z-method z-elixir">.</span>get_env<span class="z-punctuation z-section z-function z-elixir">(</span><span class="z-meta z-string z-elixir"><span class="z-string z-quoted z-double z-elixir"><span class="z-punctuation z-definition z-string z-begin z-elixir">"</span>PORT<span class="z-punctuation z-definition z-string z-end z-elixir">"</span></span></span><span class="z-punctuation z-separator z-object z-elixir">,</span> <span class="z-meta z-string z-elixir"><span class="z-string z-quoted z-double z-elixir"><span class="z-punctuation z-definition z-string z-begin z-elixir">"</span>4000<span class="z-punctuation z-definition z-string z-end z-elixir">"</span></span></span><span class="z-punctuation z-section z-function z-elixir">)</span><span class="z-punctuation z-section z-function z-elixir">)</span>
    <span class="z-punctuation z-section z-array z-elixir">]</span>
  <span class="z-keyword z-control z-elixir">end</span>
<span class="z-keyword z-control z-elixir">end</span>
</span></code></pre><p>Now when we will shutdown our application by:<pre class=z-code><code><span class="z-text z-plain"># systemctl stop hello.service
</span></code></pre><p>And we have some connections open to our service (you can simulate that with <code>wrk</code>) then when we ran <code>systemctl status hello.service</code> in separate terminal (previous will be blocked until our service shuts down) then you will be able to see something like:<pre class=z-code data-hint_scrollable=true><code><span class="z-text z-plain">â hello.service - Example Plug application
     Loaded: loaded (/usr/local/lib/systemd/system/hello.service; static; vendor preset: enabled)
          Active: deactivating (stop-sigterm) since Sat 2022-01-15 17:46:30 CET;
          1s ago
          Main PID: 1327 (beam.smp)
          Status: "draining"
          Tasks: 19 (limit: 1136)
          Memory: 106.5M
</span></code></pre><p>You can notice that the <code>Status</code> is set to <code>"draining"</code>. As soon as all connections will be drained it will change to <code>"drained"</code> and then the application will shut down and service will be marked as <code>inactive</code>.<h2 id=watchdog>Watchdog<a aria-label="Anchor link for: watchdog" class=zola-anchor href=#watchdog>#</a></h2><p>Watchdog allows us to monitor our application for responsiveness (as mentioned above). It is simple feature that requires our application to ping systemd within specified interval, otherwise the application will be forcibly shut down as malfunctioning. Fortunately for us, the <code>systemd</code> library that provides our integration, have that feature out of the box, so all we need to do to achieve expected result is set <code>WatchdogSec=</code> option in our <code>systemd.service</code> file:<pre class="language-ini z-code" data-lang=ini><code class=language-ini data-lang=ini><span class="z-source z-genconfig"><span class="z-storage z-type z-genconfig">[Unit]
</span><span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">Description</span><span class="z-keyword z-operator z-genconfig">=</span></span>Hello World service

<span class="z-storage z-type z-genconfig">[Service]
</span><span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">Environment</span><span class="z-keyword z-operator z-genconfig">=</span></span><span class="z-support z-constant z-genconfig">PORT</span><span class="z-keyword z-operator z-genconfig">=</span><span class="z-constant z-numeric z-genconfig">80</span>
<span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">Type</span><span class="z-keyword z-operator z-genconfig">=</span></span>notify
<span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">ExecStart</span><span class="z-keyword z-operator z-genconfig">=</span></span><span class="z-keyword z-operator z-genconfig">/</span>opt<span class="z-keyword z-operator z-genconfig">/</span>hello<span class="z-keyword z-operator z-genconfig">/</span>bin<span class="z-keyword z-operator z-genconfig">/</span>hello <span class="z-keyword z-other z-genconfig">start</span>
<span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">WatchdogSec</span><span class="z-keyword z-operator z-genconfig">=</span></span><span class="z-constant z-numeric z-genconfig">1min</span>
</span></code></pre><p>This configuration says that if the VM will not send healthy message each 1 minute interval, then the service will be marked as malfunctioning. From the application side we can manage state of the watchdog in several ways:<ul><li>By setting <code>systemd.watchdog_check</code> configuration option we can configure the function that will be called on each check, if that function return <code>true</code> then it mean that application is healthy and the systemd should be notified with ping, if it returns <code>false</code> or fail, then the check will be omitted.<li>Manually sending trigger message in case of detected problems via <code>:systemd.watchdog(trigger)</code>, it will immediately mark service as malfunctioning and will trigger action defined in service unit file (by default it will restart application)<li>Disabling built in watchdog process via <code>:systemd.watchdog(:disable)</code> and then manually sending <code>:systemd.watchdog(:ping)</code> within expected intervals (discouraged)</ul><h2 id=security>Security<a aria-label="Anchor link for: security" class=zola-anchor href=#security>#</a></h2><p>We should start with changing default user and group which is assigned to our process. We can do so in 2 different ways:<ol><li>Use some existing user and group by defining <code>User=</code> and <code>Group=</code> directives in our service definition; or<li>Create ephemeral user on-demand before our service starts, by using directive <code>DynamicUser=true</code> in service definition.</ol><p>I prefer second option, as it additionally provides a lot of other security related options, like creating private <code>/tmp</code> directory, making system read-only, etc. This has also some disadvantages, like removing all of given data on service shutdown, however there are options to keep some data between launches.<p>In addition to that we can add <code>PrivateDevices=true</code> that will hide all physical devices from <code>/dev</code> leaving only pseudo devices like <code>/dev/null</code> or <code>/dev/urandom</code> (so you will be able to use <code>:crypto</code> and <code>:ssl</code> modules without problems).<p>Next thing is that we can do, is to <a href=https://erlef.github.io/security-wg/secure_coding_and_deployment_hardening/crash_dumps>disable crash dumps generated by BEAM</a>. While not strictly needed in this case, it is worth remembering, that it isn't hard to achieve, it is just using <code>Environment=ERL_CRASH_DUMP_SECONDS=0</code>.<p>Our new, more secure, <code>hello.service</code> will look like:<pre class="language-ini z-code" data-lang=ini><code class=language-ini data-lang=ini><span class="z-source z-genconfig"><span class="z-storage z-type z-genconfig">[Unit]
</span><span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">Description</span><span class="z-keyword z-operator z-genconfig">=</span></span>Hello World service
<span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">Requires</span><span class="z-keyword z-operator z-genconfig">=</span></span>network<span class="z-keyword z-operator z-genconfig">.</span>target

<span class="z-storage z-type z-genconfig">[Service]
</span><span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">Type</span><span class="z-keyword z-operator z-genconfig">=</span></span>notify
<span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">Environment</span><span class="z-keyword z-operator z-genconfig">=</span></span><span class="z-support z-constant z-genconfig">PORT</span><span class="z-keyword z-operator z-genconfig">=</span><span class="z-constant z-numeric z-genconfig">80</span>
<span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">ExecStart</span><span class="z-keyword z-operator z-genconfig">=</span></span><span class="z-keyword z-operator z-genconfig">/</span>opt<span class="z-keyword z-operator z-genconfig">/</span>hello<span class="z-keyword z-operator z-genconfig">/</span>bin<span class="z-keyword z-operator z-genconfig">/</span>hello <span class="z-keyword z-other z-genconfig">start</span>
<span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">WatchdogSec</span><span class="z-keyword z-operator z-genconfig">=</span></span><span class="z-constant z-numeric z-genconfig">1min</span>

<span class="z-meta z-comment z-genconfig"><span class="z-comment z-line z-number-sign z-genconfig"># We need to add capability to be able to bind on port 80
</span></span><span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">CapabilityBoundingSet</span><span class="z-keyword z-operator z-genconfig">=</span></span><span class="z-support z-constant z-genconfig">CAP_NET_BIND_SERVICE</span>

<span class="z-meta z-comment z-genconfig"><span class="z-comment z-line z-number-sign z-genconfig"># Hardening
</span></span><span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">DynamicUser</span><span class="z-keyword z-operator z-genconfig">=</span></span><span class="z-constant z-language z-genconfig">true</span>
<span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">PrivateDevices</span><span class="z-keyword z-operator z-genconfig">=</span></span><span class="z-constant z-language z-genconfig">true</span>
<span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">Environment</span><span class="z-keyword z-operator z-genconfig">=</span></span><span class="z-support z-constant z-genconfig">ERL_CRASH_DUMP_SECONDS</span><span class="z-keyword z-operator z-genconfig">=</span><span class="z-constant z-numeric z-genconfig">0</span>
</span></code></pre><p>The problem with that configuration is that our service is now capable on binding <strong>any</strong> port under 1024, so for example, if there is some security issue, then the malicious party can open any of the restricted ports and then serve whatever data they want there. This can be quite problematic, and the solution for that problem will be covered in Part 2, where we will cover socket passing and socket activation for our service.<p>With that we achieved quite basic level of isolation to what Docker (or other container runtime) is providing, but it do not require <code>overlayfs</code> or anything more, than what you already have on your machine. That means, updates done by your system package manager will be applied to all running services. With that you do not need to rebuild all your containers when there is security patch issued for any of your dependencies.<p>Of course it only scratches the surface of what is possible with systemd wrt the hardening of the services. More information can be found in <a href=https://www.redhat.com/sysadmin/mastering-systemd>RedHat article</a> and in <a href=https://www.freedesktop.org/software/systemd/man/systemd-analyze.html#systemd-analyze%20security%20%5BUNIT...%5D><code>systemd-analyze security</code> command output</a>. Possible features are:<ul><li>creation of the private networks for your services<li>disallowing creation of socket connections that are outside of the specified set of families<li>make only some paths readable<li>hide some paths from the process<li>etc.</ul><p>Coverage of just that topic is a little bit out of scope for this blog post, so I encourage you to read the documentation of <a href=https://www.freedesktop.org/software/systemd/man/systemd.exec.html><code>systemd.exec</code></a> and articles mentioned above for more details.<h2 id=summary>Summary<a aria-label="Anchor link for: summary" class=zola-anchor href=#summary>#</a></h2><p>This blog post is already quite lengthy, so I will split it into separate parts. There probably will be 3 of them:<ul><li><a href=#top>Part 1 - Basics, security, and FD passing (this one)</a><li>Part 2 - Socket activation<li>Part 3 - Logging</ul><div class=halmos>â</div></div><hr><div><p>You can provide feedback via mailing list <a href="mailto:~hauleth/blog@lists.sr.ht?subject=[Comment]%20Who%20Watches%20Watchmen?%20-%20Part%201">~hauleth/blog@lists.sr.ht</a> (<a href=https://lists.sr.ht/~hauleth/blog>archive</a>).</p></div><div class=webmentions><p>Webmentions:<ul><li><a class=url-only href=https://www.reddit.com/r/hackernews/comments/s6o0n5/who_watches_watchmen_integrating_elixir/>https://www.reddit.com/r/hackernews/comments/s6o0n5/who_watches_watchmen_integrating_elixir/</a><li><a class=url-only href=https://lobste.rs/s/cnilmd/who_watches_watchmen_integrating_elixir>https://lobste.rs/s/cnilmd/who_watches_watchmen_integrating_elixir</a> by&nbsp;<a href=https://lobste.rs/u/hauleth>hauleth</a></ul></div></article></div><div class=pagination><div class=pagination__buttons></div></div><footer class=footer><div class=footer__inner><div class=copyright><div class=copyright--user>copyright by <a href=https://hauleth.dev/ rel=me>hauleth</a></div><div class=copyright--tracking>Public tracking available at <a href=https://plausible.io/hauleth.dev>Plausible.io</a></div></div></div></footer></div><div style=display:block;opacity:1;color-scheme:light><template shadowroot=open><iframe allowtransparency=true frameborder=0 scrolling=no class=sk_ui title=Surfingkeys style=position:fixed;left:0px;bottom:0px;width:100%;height:0px;z-index:2147483647></iframe></template></div><script data-template-shadow-root>(()=>{document.currentScript.remove();processNode(document);function processNode(node){node.querySelectorAll("template[shadowroot]").forEach(element=>{let shadowRoot = element.parentElement.shadowRoot;if (!shadowRoot) {try {shadowRoot=element.parentElement.attachShadow({mode:element.getAttribute("shadowroot")});shadowRoot.innerHTML=element.innerHTML;element.remove()} catch (error) {} if (shadowRoot) {processNode(shadowRoot)}}})}})()</script>
